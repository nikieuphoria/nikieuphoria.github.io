<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>kubenetes | The Fountainhead</title><meta name="author" content="niki,zn40489@gmail.com"><meta name="copyright" content="niki"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#FFEB3B"><meta name="description" content="一、 集群架构1.1 集群架构 概念：Master Node (控制平面) 和 Worker Node (工作节点) 的职责。  组件：  Master Node：kube-apiserver, kube-scheduler, kube-controller-manager, etcd  etcd：数据存储，键值对数据库。   Worker Node：kubelet, kube-proxy, 容器">
<meta property="og:type" content="article">
<meta property="og:title" content="kubenetes">
<meta property="og:url" content="https://nikieuphoria.github.io/2025/09/30/kubenetes/index.html">
<meta property="og:site_name" content="The Fountainhead">
<meta property="og:description" content="一、 集群架构1.1 集群架构 概念：Master Node (控制平面) 和 Worker Node (工作节点) 的职责。  组件：  Master Node：kube-apiserver, kube-scheduler, kube-controller-manager, etcd  etcd：数据存储，键值对数据库。   Worker Node：kubelet, kube-proxy, 容器">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://nikieuphoria.github.io/img/butterfly-icon.png">
<meta property="article:published_time" content="2025-09-29T16:00:00.000Z">
<meta property="article:modified_time" content="2025-09-17T10:07:13.523Z">
<meta property="article:author" content="niki">
<meta property="article:tag" content="运维">
<meta property="article:tag" content="kubenates">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://nikieuphoria.github.io/img/butterfly-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "kubenetes",
  "url": "https://nikieuphoria.github.io/2025/09/30/kubenetes/",
  "image": "https://nikieuphoria.github.io/img/butterfly-icon.png",
  "datePublished": "2025-09-29T16:00:00.000Z",
  "dateModified": "2025-09-17T10:07:13.523Z",
  "author": [
    {
      "@type": "Person",
      "name": "niki",
      "url": "https://nikieuphoria.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://nikieuphoria.github.io/2025/09/30/kubenetes/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#212121')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#FFEB3B')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'kubenetes',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/mycss.css"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="The Fountainhead" type="application/atom+xml">
</head><body><div id="web_bg" style="background-color: #efefef;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/img/3.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">The Fountainhead</span></a><a class="nav-page-title" href="/"><span class="site-name">kubenetes</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">kubenetes</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-29T16:00:00.000Z" title="发表于 2025-09-30 00:00:00">2025-09-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-17T10:07:13.523Z" title="更新于 2025-09-17 18:07:13">2025-09-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/k8s/">k8s</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">9.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>36分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="一、-集群架构"><a href="#一、-集群架构" class="headerlink" title="一、 集群架构"></a>一、 集群架构</h2><h3 id="1-1-集群架构"><a href="#1-1-集群架构" class="headerlink" title="1.1 集群架构"></a>1.1 集群架构</h3><ul>
<li><p><strong>概念</strong>：Master Node (控制平面) 和 Worker Node (工作节点) 的职责。</p>
</li>
<li><p><strong>组件</strong>：</p>
<ul>
<li><p><strong>Master Node</strong>：<code>kube-apiserver</code>, <code>kube-scheduler</code>, <code>kube-controller-manager</code>, <code>etcd</code></p>
<ul>
<li><code>etcd</code>：数据存储，键值对数据库。</li>
</ul>
</li>
<li><p><strong>Worker Node</strong>：<code>kubelet</code>, <code>kube-proxy</code>, 容器运行时 (Container Runtime, 如 containerd&#x2F;Docker)。</p>
</li>
</ul>
</li>
<li><p><strong>关键点</strong>：各组件功能、通信方式。</p>
</li>
<li><p><strong>思维导图&#x2F;草图</strong>：绘制K8s集群组件图。</p>
</li>
</ul>
<h3 id="1-2-API-对象-API-Objects"><a href="#1-2-API-对象-API-Objects" class="headerlink" title="1.2 API 对象 (API Objects)"></a>1.2 API 对象 (API Objects)</h3><ul>
<li><strong>概念</strong>：K8s 中一切皆对象。</li>
</ul>
<p>K8s 把资源按功能、稳定性、来源，分成不同的 group，每个 group 里可能有几个资源种类（kind）+ 各自的版本（v1）。</p>
<table>
<thead>
<tr>
<th>Kind</th>
<th>usage</th>
</tr>
</thead>
<tbody><tr>
<td><code>Pod</code></td>
<td>最基本的运行单元</td>
</tr>
<tr>
<td><code>Service</code></td>
<td>网络访问入口，抽象 Pod 集合</td>
</tr>
<tr>
<td><code>ConfigMap</code></td>
<td>配置数据，挂进容器</td>
</tr>
<tr>
<td><code>Secret</code></td>
<td>加密信息（密码、token）</td>
</tr>
<tr>
<td><code>PersistentVolume</code></td>
<td>静态磁盘资源</td>
</tr>
<tr>
<td><code>PersistentVolumeClaim</code></td>
<td>申请磁盘</td>
</tr>
<tr>
<td><code>Namespace</code></td>
<td>空间隔离，逻辑项目划分</td>
</tr>
<tr>
<td><code>Node</code></td>
<td>集群节点，通常由系统管理</td>
</tr>
<tr>
<td><code>LimitRange</code></td>
<td>限制单个 Pod 资源使用范围</td>
</tr>
<tr>
<td><code>ResourceQuota</code></td>
<td>限制整个 namespace 的资源用量</td>
</tr>
</tbody></table>
<h3 id="1-3-YAML-文件-YAML-Files"><a href="#1-3-YAML-文件-YAML-Files" class="headerlink" title="1.3 YAML 文件 (YAML Files)"></a>1.3 YAML 文件 (YAML Files)</h3><ul>
<li><p><strong>概念</strong>：K8s 配置文件的主要格式。</p>
</li>
<li><p><strong>YAML 基础</strong>：缩进、键值对、列表、块序列。</p>
</li>
<li><p><strong><code>kubectl</code> 配合</strong>：<code>kubectl apply -f &lt;file.yaml&gt;</code>, <code>kubectl create -f &lt;file.yaml&gt; --dry-run=client -o yaml &gt; output.yaml</code>。</p>
</li>
</ul>
<h3 id="1-4-kubectl-基础-kubectl-Basics"><a href="#1-4-kubectl-基础-kubectl-Basics" class="headerlink" title="1.4 kubectl 基础 (kubectl Basics)"></a>1.4 <code>kubectl</code> 基础 (kubectl Basics)</h3><ul>
<li><p><strong>配置</strong>：<code>~/.kube/config</code> 文件。</p>
</li>
<li><p><strong>常用命令</strong>：</p>
<ul>
<li><p><code>kubectl get &lt;resource&gt; -o wide</code></p>
</li>
<li><p><code>kubectl describe &lt;resource&gt; &lt;name&gt;</code></p>
</li>
<li><p><code>kubectl create/apply/delete -f &lt;file.yaml&gt;</code></p>
</li>
<li><p><code>kubectl edit &lt;resource&gt; &lt;name&gt;</code></p>
</li>
<li><p><code>kubectl run &lt;pod-name&gt; --image=&lt;image&gt; --restart=Never --dry-run=client -o yaml</code></p>
</li>
<li><p><code>kubectl logs &lt;pod-name&gt; [-c &lt;container-name&gt;]</code></p>
</li>
<li><p><code>kubectl exec -it &lt;pod-name&gt; [-c &lt;container-name&gt;] -- bash</code></p>
</li>
</ul>
</li>
<li><p><strong>命令速查表</strong>：整理常用的 <code>kubectl</code> 命令和参数。</p>
</li>
<li><p><strong>技巧</strong>：<code>--dry-run=client -o yaml</code>, <code>--force</code>, <code>-w</code> (watch)。</p>
</li>
</ul>
<h2 id="二、集群安装与配置"><a href="#二、集群安装与配置" class="headerlink" title="二、集群安装与配置"></a>二、集群安装与配置</h2><h3 id="2-1-kubeadm-工具-kubeadm-Tool"><a href="#2-1-kubeadm-工具-kubeadm-Tool" class="headerlink" title="2.1 kubeadm 工具 (kubeadm Tool)"></a>2.1 <code>kubeadm</code> 工具 (kubeadm Tool)</h3><ul>
<li><strong>概念</strong>：用于快速安装 K8s 集群的工具。</li>
</ul>
<h3 id="2-2-组件配置-Component-Configuration"><a href="#2-2-组件配置-Component-Configuration" class="headerlink" title="2.2 组件配置 (Component Configuration)"></a>2.2 组件配置 (Component Configuration)</h3><ul>
<li><p><strong><code>kubelet</code></strong>：配置 (Cgroup Driver, <code>kubeconfig</code> 路径)。</p>
</li>
<li><p><strong>API Server</strong>：端口、认证方式、准入控制器 (Admission Controllers)。</p>
</li>
<li><p><strong>Controller Manager &#x2F; Scheduler</strong>：相关启动参数。</p>
</li>
</ul>
<h3 id="2-3-证书管理-Certificate-Management"><a href="#2-3-证书管理-Certificate-Management" class="headerlink" title="2.3 证书管理 (Certificate Management)"></a>2.3 证书管理 (Certificate Management)</h3><ul>
<li><p><strong>概念</strong>：K8s 各组件间通过 TLS 证书进行安全通信。</p>
</li>
<li><p><strong>核心证书</strong>：<code>ca.crt</code>, <code>ca.key</code>, <code>apiserver.crt</code>, <code>apiserver.key</code>, <code>kubelet.crt</code>, <code>kubelet.key</code> 等。</p>
</li>
<li><p><strong>签发方式</strong>：<code>kubeadm</code> 自动管理、手动签发 (<code>cfssl</code> 或 <code>openssl</code>)。</p>
</li>
<li><p><strong>续期</strong>：<code>kubeadm certs renew</code>。</p>
</li>
</ul>
<h3 id="2-4-备份与恢复-Backup-Restore"><a href="#2-4-备份与恢复-Backup-Restore" class="headerlink" title="2.4 备份与恢复 (Backup &amp; Restore)"></a>2.4 备份与恢复 (Backup &amp; Restore)</h3><ul>
<li><p><strong>ETCD 备份</strong>：</p>
<ul>
<li><p>概念：K8s 所有集群状态都存储在 ETCD 中。</p>
</li>
<li><p>命令：<code>etcdctl snapshot save</code>, <code>etcdctl snapshot restore</code>。</p>
</li>
<li><p>关键参数：证书路径 (<code>--cacert</code>, <code>--cert</code>, <code>--key</code>)。</p>
</li>
</ul>
</li>
<li><p><strong>恢复步骤</strong>：停止 <code>kube-apiserver</code>, <code>kube-controller-manager</code>, <code>kube-scheduler</code>, 恢复 ETCD, 重启组件。</p>
</li>
</ul>
<h2 id="三、应用生命周期管理"><a href="#三、应用生命周期管理" class="headerlink" title="三、应用生命周期管理"></a>三、应用生命周期管理</h2><h3 id="3-1-Pod-管理-Pod-Management"><a href="#3-1-Pod-管理-Pod-Management" class="headerlink" title="3.1 Pod 管理 (Pod Management)"></a>3.1 Pod 管理 (Pod Management)</h3><ul>
<li><strong>概念</strong>：K8s 最小调度单位，包含一个或多个容器。</li>
<li><strong>生命周期</strong>：Pending, Running, Succeeded, Failed, Unknown。</li>
<li><strong>重启策略</strong>：Always, OnFailure, Never。</li>
<li><strong>共享资源</strong>：网络、存储。</li>
</ul>
<p><strong>Pod</strong> 是可以在 Kubernetes 中创建和管理的、最小的可部署的计算单元。</p>
<p><strong>容器之间共享：</strong></p>
<ul>
<li>网络命名空间（同一个 IP，端口互通）</li>
<li>存储卷（Volume）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods              <span class="comment"># 查看 Pod 列表</span></span><br><span class="line">kubectl describe pod my-pod   <span class="comment"># 查看详细信息</span></span><br><span class="line">kubectl logs my-pod           <span class="comment"># 查看日志</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it my-pod -- /bin/bash  <span class="comment"># 进容器</span></span><br><span class="line">kubectl delete pod my-pod     <span class="comment"># 删除 Pod</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>共享网络：<strong>通过Pause容器，把其他业务容器加入到Pause容器里面，让所有业务容器在同一个名称空间中，可以实现网络共享。</strong></li>
</ul>
<p>容器本身之间相互隔离的（namespace、group）<br>前提条件：容器在同一个ns里面<br>每一个Pod都有一个特殊的被称为“根容器”的pause容器。</p>
<h4 id="3-1-1创建pod的方式"><a href="#3-1-1创建pod的方式" class="headerlink" title="3.1.1创建pod的方式"></a>3.1.1创建pod的方式</h4><h5 id="kubectl-run临时创建"><a href="#kubectl-run临时创建" class="headerlink" title="kubectl run临时创建"></a>kubectl run临时创建</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run tomcat --image=xianchao/tomcat-8.5-jre8:v1  --image-pull-policy=<span class="string">&#x27;IfNotPresent&#x27;</span>  --port=8080</span><br></pre></td></tr></table></figure>

<h5 id="用-YAML-文件创建-Pod"><a href="#用-YAML-文件创建-Pod" class="headerlink" title="用 YAML 文件创建 Pod"></a>用 YAML 文件创建 Pod</h5><p>#<strong>工作节点</strong>上ctr导入镜像 ctr -n&#x3D;<a target="_blank" rel="noopener" href="http://k8s.io/">k8s.io</a> images import xianchao-tomcat.tar.gz #查看导入镜像 ctr -n&#x3D;<a target="_blank" rel="noopener" href="http://k8s.io/">k8s.io</a> images list |grep nginx</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tomcat</span>  <span class="comment">#Pod的名字</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapip</span></span><br><span class="line"><span class="attr">spec:</span> <span class="comment">#规格规范</span></span><br><span class="line">  <span class="attr">containers:</span>   <span class="comment">#必须写的字段</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat-c</span>  <span class="comment">#Pod里容器的名字</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">xianchao/tomcat-8.5-jre8:v1</span>  </span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>定义一个Pod资源，Pod被删除，就彻底被删除</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# kubectl apply -f pod-tomcat.yaml</span><br><span class="line">[root@master ~]# kubectl describe pod tomcat -n default</span><br><span class="line">Name:             tomcat</span><br><span class="line">Namespace:        default</span><br><span class="line">Priority:         0</span><br><span class="line">Service Account:  default</span><br><span class="line">Node:             node1/172.20.196.18</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># YAML 里没指定pod分配到哪个node上，master node上的scheduler 自己分配到pode1。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="控制器创建"><a href="#控制器创建" class="headerlink" title="控制器创建"></a>控制器创建</h5><p>常见的管理Pod的控制器：Replicaset、Deployment、Job、CronJob、Daemonset、Statefulset。</p>
<p>控制器管理的Pod可以确保Pod始终维持在<strong>指定的副本数</strong>运行。</p>
<p>pod,spec.selector-<strong>标签过滤器</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1  <span class="comment">#Kubernetes 的 API 版本，apps/v1 是这类控制器的标准版本</span></span><br><span class="line">kind: Deployment   <span class="comment">#创建控制器</span></span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-test</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-deploy</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: xianchao/nginx:v1</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除控制器</span></span><br><span class="line">kubectl delete deployment &lt;deployment-name&gt;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-2-资源配额"><a href="#3-1-2-资源配额" class="headerlink" title="3.1.2 资源配额"></a>3.1.2 资源配额</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#定义resource quota应用到namespace</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">resource1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">resourcequota-label:</span> <span class="string">ns-test-label</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">limits.cpu:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">limits.memory:</span> <span class="string">2Gi</span></span><br><span class="line">    <span class="attr">requests.cpu:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">requests.memory:</span> <span class="string">1Gi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#应用资源配额</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">namespace-quota.yaml</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="3-2pod生命周期"><a href="#3-2pod生命周期" class="headerlink" title="3.2pod生命周期"></a>3.2pod生命周期</h3><h4 id="3-2-1Pod的五个阶段（Phase）"><a href="#3-2-1Pod的五个阶段（Phase）" class="headerlink" title="3.2.1Pod的五个阶段（Phase）"></a>3.2.1Pod的五个阶段（Phase）</h4><p>pod从开pod从开始创建到终止退出的时间范围称为Pod生命周期始创建到终止退出的时间范围称为Pod生命周期 在整个生命周期中，Pod会出现几种<strong>状态</strong>（<strong>相位</strong>）：</p>
<ol>
<li><strong>Pending</strong><ul>
<li>API Server 收到你创建 Pod 的请求，Pod 信息写进 etcd</li>
<li>还没调度到节点，或者镜像还在拉取</li>
</ul>
</li>
<li><strong>ContainerCreating</strong><ul>
<li>调度器找好节点，Kubelet 开始创建 pause 容器、挂卷、拉镜像</li>
</ul>
</li>
<li><strong>Running</strong><ul>
<li>所有容器启动成功，开始对外提供服务</li>
<li>期间会跑健康探针（存活性&#x2F;就绪性）来判断是不是还活着</li>
</ul>
</li>
<li><strong>Succeeded</strong><ul>
<li>Pod 里的容器都正常结束（退出码 0）</li>
<li>常见于一次性任务（Job）</li>
</ul>
</li>
<li><strong>Failed</strong><ul>
<li>所有容器都结束了，但至少一个是异常退出（退出码非 0）</li>
</ul>
</li>
<li><strong>Unknown</strong><ul>
<li>K8s 根本问不到节点的 kubelet 状态，Pod 状态成谜</li>
</ul>
</li>
</ol>
<h4 id="3-2-2pod重启策略"><a href="#3-2-2pod重启策略" class="headerlink" title="3.2.2pod重启策略"></a>3.2.2pod重启策略</h4><p>Pod的重启策略（RestartPolicy）应用于Pod内的所有容器，当某个容器异常退出或者健康检查失败时，kubelet将根据 重启策略来进行相应的操作。</p>
<p>Pod.spec.restartPolicy</p>
<ul>
<li>Always：只要容器异常退出，kubelet就会自动重启该容器。（这个是默认的重启策略）</li>
<li>OnFailure：当容器终止运行且退出码不为0时，由kubelet自动重启该容器。</li>
<li>Never：不论容器运行状态如何，kubelet都不会重启该容器。</li>
</ul>
<h4 id="3-2-3Init-容器：主容器前的准备工序"><a href="#3-2-3Init-容器：主容器前的准备工序" class="headerlink" title="3.2.3Init 容器：主容器前的准备工序"></a><strong>3.2.3Init 容器</strong>：主容器前的准备工序</h4><ul>
<li><strong>创建 pause 容器</strong><ul>
<li>Pod 的第一个容器，主要干网络和命名空间的事，其他容器都挂它下面</li>
</ul>
</li>
<li><strong>跑 Init 容器（InitContainers）</strong><ul>
<li>顺序执行，干完才能启动主容器</li>
<li>常用来准备数据、等依赖服务可用</li>
</ul>
</li>
<li><strong>启动主容器（Containers）</strong><ul>
<li>正式跑业务代码的地方</li>
</ul>
</li>
</ul>
<h4 id="3-2-4hooks钩子"><a href="#3-2-4hooks钩子" class="headerlink" title="3.2.4hooks钩子"></a>3.2.4hooks钩子</h4><p>pod.spec.containers.lifecycle.</p>
<ul>
<li><strong>PostStart</strong>：容器刚启动就执行</li>
<li><strong>PreStop</strong>：容器结束前执行（可做清理或优雅下线）</li>
</ul>
<p>当用户请求删除含有pod的资源对象时（如RC、deployment等），K8S为了让应用程序优雅关闭（<strong>即让应用程序完成正在处理的请求后，再关闭软件</strong>），K8S提供两种信息通知：</p>
<ul>
<li>默认情况下，K8s 调用 <code>docker stop</code>，容器先接收 SIGTERM 信号，若应用在超时时间内未退出，则强制 SIGKILL。</li>
<li>若配置了 <code>preStop</code> 回调，则在 SIGTERM 前会先执行预定义操作，从而实现更平滑的下线。</li>
</ul>
<p> 案例演示</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">life-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lifecycle-demo-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/xianchao/nginx:v1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">         <span class="attr">exec:</span></span><br><span class="line">           <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;lifecycle hookshandler&#x27; &gt; /usr/share/nginx/html/test.html&quot;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">         <span class="attr">exec:</span></span><br><span class="line">           <span class="attr">command:</span></span><br><span class="line">           <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">           <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">           <span class="bullet">-</span> <span class="string">&quot;nginx -s stop&quot;</span></span><br></pre></td></tr></table></figure>

<p>curl ip&#x2F;test.html</p>
<h4 id="3-2-5probe探针"><a href="#3-2-5probe探针" class="headerlink" title="3.2.5probe探针"></a>3.2.5probe探针</h4><h5 id="1-Liveness-Probe（存活探针）"><a href="#1-Liveness-Probe（存活探针）" class="headerlink" title="1. Liveness Probe（存活探针）"></a>1. Liveness Probe（存活探针）</h5><p><strong>作用</strong>：检测容器是否还在运行</p>
<ul>
<li>如果检测失败，kubelet会杀死容器，然后根据重启策略决定是否重启</li>
<li>用于检测应用程序死锁、无响应等情况</li>
</ul>
<p><strong>使用场景</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="2-Readiness-Probe（就绪探针）"><a href="#2-Readiness-Probe（就绪探针）" class="headerlink" title="2. Readiness Probe（就绪探针）"></a>2. Readiness Probe（就绪探针）</h5><p><strong>作用</strong>：检测容器是否准备好接收流量</p>
<ul>
<li>如果检测失败，会将Pod从Service的Endpoints中移除，停止转发流量</li>
<li>容器不会被重启，只是暂时不接收请求</li>
</ul>
<p><strong>使用场景</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">readinessProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/ready</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-Startup-Probe（启动探针）"><a href="#3-Startup-Probe（启动探针）" class="headerlink" title="3. Startup Probe（启动探针）"></a>3. Startup Probe（启动探针）</h5><p><strong>作用</strong>：检测容器内的<strong>应用程序</strong>是否已经启动</p>
<ul>
<li>在Startup Probe成功之前，其他两个探针会被禁用</li>
<li>主要用于启动时间较长的容器</li>
</ul>
<p><strong>使用场景</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">startupProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/startup</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="探针检测方式"><a href="#探针检测方式" class="headerlink" title="探针检测方式"></a>探针检测方式</h5><p><strong>HTTP GET</strong>：发送HTTP请求，返回200-399状态码表示成功<br><strong>TCP Socket</strong>：尝试建立TCP连接<br><strong>Exec</strong>：在容器内执行命令，返回码为0表示成功</p>
<p> 关键参数</p>
<ul>
<li><code>initialDelaySeconds</code>：容器启动后延迟多久开始探测</li>
<li><code>periodSeconds</code>：探测间隔时间</li>
<li><code>timeoutSeconds</code>：探测超时时间</li>
<li><code>successThreshold</code>：连续成功次数阈值</li>
<li><code>failureThreshold</code>：连续失败次数阈值</li>
</ul>
<p>这三个探针配合使用，可以确保应用程序的健康运行和流量的正确路由。</p>
<h3 id="3-3-DaemonSet-守护进程集"><a href="#3-3-DaemonSet-守护进程集" class="headerlink" title="3.3 DaemonSet (守护进程集)"></a>3.3 DaemonSet (守护进程集)</h3><ul>
<li><strong>概念</strong>：确保每个节点（或符合特定条件的节点）运行一个 Pod 副本。</li>
<li><strong>使用场景</strong>：日志收集代理 (Fluentd), 监控代理 (Node Exporter), 网络插件。</li>
</ul>
<h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>DaemonSet 确保集群中每个节点都运行指定 Pod 的一个副本，常用于系统级服务</p>
<h4 id="主要特性"><a href="#主要特性" class="headerlink" title="主要特性"></a>主要特性</h4><ol>
<li><strong>一对一关系</strong>：每个符合条件的节点上最多运行一个 DaemonSet Pod</li>
<li><strong>自动调度</strong>：新节点加入集群时，自动在该节点创建 Pod</li>
<li><strong>自动清理</strong>：节点离开集群时，相应的 Pod 会被删除</li>
<li><strong>节点亲和性</strong>：可通过 nodeSelector、tolerations 等控制在哪些节点运行</li>
</ol>
<h4 id="典型应用场景"><a href="#典型应用场景" class="headerlink" title="典型应用场景"></a>典型应用场景</h4><ul>
<li><strong>日志收集</strong>：Fluentd、Filebeat 等在每个节点收集日志</li>
<li><strong>监控代理</strong>：Node Exporter、cAdvisor 等监控节点资源</li>
<li><strong>网络插件</strong>：Calico、Flannel 等网络组件</li>
<li><strong>存储守护进程</strong>：Ceph、GlusterFS 等分布式存储</li>
<li><strong>安全扫描</strong>：在每个节点运行安全检查工具、</li>
<li></li>
</ul>
<h4 id="yaml示例"><a href="#yaml示例" class="headerlink" title="yaml示例"></a>yaml示例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ds-1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">f-log</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span>   <span class="comment">#标签选择器</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">f-log</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span>   <span class="comment">#基于这回模板定义的pod具有的标签</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">f-log</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">tolerations:</span>   <span class="comment">#定义容忍度</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span>    </span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fluentd-elasticsearch</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">xianchao/fluentd:v2.5.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">resources:</span>          <span class="comment">#资源配额</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span>  <span class="comment"># 停止 Pod 前等待 30 秒</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span>       <span class="comment">#基于本地目录创建一个卷</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>tolerations：</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span>   <span class="comment"># 定义 Pod 的容忍度</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span>    <span class="comment"># 匹配节点上带的 taint key</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">NoSchedule</span>                     <span class="comment"># 表示该 taint 的效果：禁止调度</span></span><br></pre></td></tr></table></figure>
<p>  <strong>解释</strong>：</p>
<ul>
<li><p><strong>背景</strong>：K8s 默认会在 master 节点上打一个 taint：</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key=node-role.kubernetes.io/master:NoSchedule</span><br></pre></td></tr></table></figure>
<p>  意思是：一般的 Pod 不允许调度到 master 节点上。</p>
</li>
<li><p><strong>tolerations</strong>：加了这个字段，Pod 就能“容忍”这个 taint，从而允许被调度到 master 节点。</p>
</li>
</ul>
<p>  <strong>备注总结</strong>：</p>
<ul>
<li><code>taint</code> 是节点的“驱赶规则”</li>
<li><code>toleration</code> 是 Pod 的“免死金牌”</li>
<li>这个例子就是：Pod 可以调度到 master 节点，不会因为 <code>NoSchedule</code> 被拒绝。</li>
</ul>
</li>
</ul>
<h3 id="3-4-StatefulSet-有状态集"><a href="#3-4-StatefulSet-有状态集" class="headerlink" title="3.4 StatefulSet (有状态集)"></a>3.4 StatefulSet (有状态集)</h3><ul>
<li><strong>概念</strong>：管理有状态应用（如数据库），确保 Pod 的唯一性、持久性存储和有序部署&#x2F;扩展&#x2F;删除。</li>
<li><strong>关键特性</strong>：稳定的网络标识、稳定的持久化存储、有序的启动&#x2F;停止&#x2F;更新。</li>
</ul>
<p>前面我们部署的应用，都是不需要存储数据，不需要记住状态的，可以随意扩充副本，每个副本都是一样的，可替代的。<br>而像数据库、Redis 这类有状态的，则不能随意扩充副本。<br>StatefulSet 会固定每个 Pod 的名字</p>
<h4 id="StatefulSet-特性"><a href="#StatefulSet-特性" class="headerlink" title="StatefulSet 特性"></a><strong>StatefulSet 特性</strong></h4><ul>
<li><strong>网络标识：</strong><ul>
<li>必须配合 Headless Service（<code>clusterIP: None</code>）。</li>
<li>这样 Pod 会有固定的 DNS 解析，比如 <code>pod.name.svc-name.namespace.svc.cluster.local</code></li>
<li>因此应用不要用 Pod IP，应该用 Pod 的 DNS 名。</li>
</ul>
</li>
<li><strong>顺序控制</strong><ul>
<li>Pod 创建和销毁是有序的，创建是顺序的，销毁是逆序的。</li>
</ul>
</li>
<li><strong>稳定的存储</strong><ul>
<li>搭配 VolumeClaimTemplates实现了<strong>动态存储供应</strong>，每个 Pod 会有独立的 PVC，比如 <code>data-web-0</code>, <code>data-web-1</code>。</li>
<li>即使 Pod 重建，挂载的 PVC 还是之前那个，不会丢数据。</li>
</ul>
</li>
</ul>
<aside> 💡

<p>Headless Service</p>
<ul>
<li><strong>普通服务</strong>会为所有 Pods 提供一个单一的虚拟 IP 地址，并负责在这些 Pods 之间进行负载均衡。</li>
<li><strong>无头服务</strong>（Headless Service）则没有这个虚拟 IP。它的主要作用是为每个 Pod 提供一个<strong>独立的 DNS 域名</strong>。 </li></ul></aside>

<h6 id="yaml示例-1"><a href="#yaml示例-1" class="headerlink" title="yaml示例"></a>yaml示例</h6><p><img src="/images/statefulset.drawio.png" alt="statefulset"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">创建headless service</span><br><span class="line">创建statefulset，2副本，模板为以nginx为镜像的容器，设置挂载点，使用叫nfs的sc</span><br><span class="line">volumeClaimTemplates使用命名为nfs的storageclass，为每个 Pod 生成独立的 PVC，PVC 再通过 StorageClass 动态申请并绑定到 PV</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata: </span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">     app: nginx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    name: web</span><br><span class="line">  clusterIP: None   #headless服务</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata: </span><br><span class="line">  name: web</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  serviceName: &quot;nginx&quot;     #headless service的名字</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata: </span><br><span class="line">     labels:</span><br><span class="line">       app: nginx</span><br><span class="line">    spec: </span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: web</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: www</span><br><span class="line">          mountPath: /usr/share/nginx/html</span><br><span class="line">  volumeClaimTemplates:    #存储卷申请模板</span><br><span class="line">  - metadata:</span><br><span class="line">      name: www</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [&quot;ReadWriteOnce&quot;]</span><br><span class="line">      storageClassName: &quot;nfs&quot;    #指定从哪个sc存储类申请pv</span><br><span class="line">      resources:</span><br><span class="line">        requests: </span><br><span class="line">          storage: 1Gi</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="3-5-configmap与secret"><a href="#3-5-configmap与secret" class="headerlink" title="3.5 configmap与secret"></a>3.5 configmap与secret</h3><h4 id="configmap"><a href="#configmap" class="headerlink" title="configmap"></a>configmap</h4><p><strong>把配置抽离出来，集中管理，方便一改多用</strong>。</p>
<ul>
<li>一种 <strong>Kubernetes 原生对象</strong>，用来存储 <strong>配置数据</strong>（非敏感信息）。</li>
<li>数据以 <strong>键值对 (key-value)</strong> 的形式存在。</li>
<li>Pod 可以通过 <strong>环境变量</strong> 或者 <strong>挂载文件</strong> 的方式读取 ConfigMap。</li>
</ul>
<h5 id="1-创建ConfigMap的方式"><a href="#1-创建ConfigMap的方式" class="headerlink" title="1. 创建ConfigMap的方式"></a>1. 创建ConfigMap的方式</h5><h6 id="直接用kubectl命令"><a href="#直接用kubectl命令" class="headerlink" title="直接用kubectl命令"></a>直接用kubectl命令</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从字面值创建</span></span><br><span class="line">kubectl create configmap my-config --from-literal=key1=value1 --from-literal=key2=value2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从文件创建</span></span><br><span class="line">kubectl create configmap app-config --from-file=config.properties</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从目录创建</span></span><br><span class="line">kubectl create configmap configs --from-file=./config-dir/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="用YAML文件"><a href="#用YAML文件" class="headerlink" title="用YAML文件"></a>用YAML文件</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">database_url:</span> <span class="string">&quot;mysql://localhost:3306/mydb&quot;</span></span><br><span class="line">  <span class="attr">log_level:</span> <span class="string">&quot;info&quot;</span></span><br><span class="line">  <span class="attr">config.properties:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    server.port=8080</span></span><br><span class="line"><span class="string">    server.host=0.0.0.0</span></span><br><span class="line"><span class="string">    debug=true</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<h5 id="2-在Pod中使用ConfigMap"><a href="#2-在Pod中使用ConfigMap" class="headerlink" title="2. 在Pod中使用ConfigMap"></a>2. 在Pod中使用ConfigMap</h5><table>
<thead>
<tr>
<th>方式</th>
<th>用途</th>
<th>注入形式</th>
<th>场景</th>
</tr>
</thead>
<tbody><tr>
<td>configMapKeyRef</td>
<td>精确注入单个环境变量</td>
<td>特定键值对作为环境变量</td>
<td>只注入少量或特定配置</td>
</tr>
<tr>
<td>envFrom</td>
<td>批量注入环境变量</td>
<td>键值对作为环境变量</td>
<td>注入大量公共配置</td>
</tr>
<tr>
<td>Volume 挂载</td>
<td>注入配置文件</td>
<td>键值对作为文件</td>
<td>注入完整的 .conf, .properties 等配置文件</td>
</tr>
</tbody></table>
<h6 id="envfrom"><a href="#envfrom" class="headerlink" title="envfrom"></a>envfrom</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-with-bulk-config</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">envFrom:</span></span><br><span class="line">    <span class="comment"># 批量注入所有键值对作为环境变量</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">my-config</span></span><br><span class="line">    <span class="comment"># 可以添加前缀避免冲突</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="configMapKeyRef"><a href="#configMapKeyRef" class="headerlink" title="configMapKeyRef"></a>configMapKeyRef</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-with-specific-config</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="comment"># 注入单个配置项</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">APP_MODE</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">my-config</span>           <span class="comment"># ConfigMap 名称</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">APP_MODE</span>            <span class="comment"># 指定的键</span></span><br></pre></td></tr></table></figure>

<h6 id="做成volume挂载"><a href="#做成volume挂载" class="headerlink" title="做成volume挂载"></a>做成volume挂载</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-with-config-files</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="comment"># 挂载完整 ConfigMap</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/config</span>      <span class="comment"># 挂载到容器的路径</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="comment"># 挂载完整 ConfigMap</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">my-config</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ConfigMap更新后，环境变量不会自动更新，但挂载的文件会（有一定延迟）。生产环境中建议用文件挂载方式，更灵活。</p>
<h2 id="四、调度"><a href="#四、调度" class="headerlink" title="四、调度"></a>四、调度</h2><p>在 Kubernetes 中，Pod 默认由调度器（Scheduler）<strong>自动选择合适的节点</strong>来运行。如果想<strong>手动控制 Pod 去哪个节点</strong>，可以使用以下几种方式：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>优点</th>
<th>缺点</th>
<th>场景</th>
</tr>
</thead>
<tbody><tr>
<td>nodeName</td>
<td>简单直接</td>
<td>死板，不推荐</td>
<td>测试&#x2F;调试</td>
</tr>
<tr>
<td>nodeSelector</td>
<td>快速精准</td>
<td>功能弱</td>
<td>简单需求</td>
</tr>
<tr>
<td>nodeAffinity</td>
<td>灵活强大</td>
<td>配置稍多</td>
<td>精准调度</td>
</tr>
<tr>
<td>tolerations</td>
<td>控制流入</td>
<td>需要配合 taint</td>
<td>节点隔离</td>
</tr>
</tbody></table>
<h3 id="nodeName"><a href="#nodeName" class="headerlink" title="nodeName"></a>nodeName</h3><p>指定pod节点运行在哪个具体node上<br>kubectl explain pod.spec.nodeName</p>
<h3 id="4-1-节点选择器-Node-Selector"><a href="#4-1-节点选择器-Node-Selector" class="headerlink" title="4.1 节点选择器 (Node Selector)"></a>4.1 节点选择器 (Node Selector)</h3><ul>
<li><p><strong>概念</strong>：最简单的调度方式，通过 Pod 的 <code>nodeSelector</code> 字段与 Node 的 <code>labels</code> 匹配。</p>
</li>
<li><p><strong>YAML 示例</strong>：<br>  kubectl explain pod.spec.nodeSelector</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">label</span> <span class="string">nodes</span> <span class="string">node-1</span> <span class="string">disktype=ssd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#yaml文件中</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">disktype:</span> <span class="string">ssd</span></span><br></pre></td></tr></table></figure>

<p>一个 Pod 的 YAML 文件里，kubectl explain pod.spec.nodeSelector</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">label</span> <span class="string">nodes</span> <span class="string">node-1</span> <span class="string">disktype=ssd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#yaml文件中</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">disktype:</span> <span class="string">ssd</span></span><br></pre></td></tr></table></figure>

<p>一个 Pod 的 YAML 文件里，<strong>如果同时用了 <code>nodeName</code> 和 <code>nodeSelector</code>，那就必须同时满足这俩条件，缺一不可，否则就会调度失败，Pod 一直 Pending</strong></p>
<h3 id="4-2-节点亲和性-Node-Affinity"><a href="#4-2-节点亲和性-Node-Affinity" class="headerlink" title="4.2 节点亲和性 (Node Affinity)"></a>4.2 节点亲和性 (Node Affinity)</h3><ul>
<li><p><strong>概念</strong>：更灵活的调度方式，基于 Node 标签进行“亲和”或“反亲和”调度。</p>
</li>
<li><p><strong>类型</strong>：</p>
<ul>
<li><code>requiredDuringSchedulingIgnoredDuringExecution</code> (硬性要求)</li>
<li><code>preferredDuringSchedulingIgnoredDuringExecution</code> (软性要求)</li>
</ul>
</li>
<li><p><strong>YAML 示例</strong>：</p>
</li>
</ul>
<h4 id="required（硬亲和性）"><a href="#required（硬亲和性）" class="headerlink" title="required（硬亲和性）"></a>required（硬亲和性）</h4><p><strong>必须满足</strong>，不满足Pod 就卡在 Pending</p>
<ul>
<li>nodeSelectorTerms:<ul>
<li><ul>
<li>matchExpressions:<br>- - key: type1 operator: “In” values:</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-test2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns-test</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">tomcat-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat-container</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">docker.io/xianchao/tomcat-8.5-jre8:v1</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">matchExpressions:</span>     <span class="comment">#多个键值对时是 AND 关系（全部条件都要满足）</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">type1</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">&quot;In&quot;</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">va1</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">niki</span></span><br><span class="line">             </span><br></pre></td></tr></table></figure>

<hr>
<h4 id="preferred（软亲和性）"><a href="#preferred（软亲和性）" class="headerlink" title="preferred（软亲和性）"></a>preferred（软亲和性）</h4><p><strong>加分项</strong>，满足条件更优先。权重越高，pod调度的几率越大</p>
<ul>
<li><ul>
<li>preference:</li>
</ul>
</li>
<li>weight:</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">affinity:</span></span><br><span class="line">  <span class="attr">nodeAffinity:</span></span><br><span class="line">    <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">type1</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">value1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="4-3-Pod-Affinity-Anti-Affinity"><a href="#4-3-Pod-Affinity-Anti-Affinity" class="headerlink" title="4.3 Pod Affinity&#x2F;Anti-Affinity"></a>4.3 Pod Affinity&#x2F;Anti-Affinity</h3><ul>
<li><p><strong>概念</strong>：基于集群中<strong>其他 Pod 的标签</strong>来调度 Pod。</p>
</li>
<li><p><strong>Pod Affinity</strong>：将 Pod 调度到特定 Pod 附近。</p>
</li>
<li><p><strong>Pod Anti-Affinity</strong>：将 Pod 远离特定 Pod 调度（如避免单点故障）。</p>
</li>
<li><p><strong>类型</strong>：<code>required</code>, <code>preferred</code>。</p>
</li>
</ul>
<h4 id="1-podAffinity-跟哪些pod一起"><a href="#1-podAffinity-跟哪些pod一起" class="headerlink" title="1.podAffinity -跟哪些pod一起"></a>1.podAffinity -跟哪些pod一起</h4><p>通过 label 来筛选一批 Pod，亲和性调度只影响<strong>调度时</strong>。</p>
<p>在 Pod Affinity 规则里，先用 labelSelector 找出符合条件的 Pod，再用 topologyKey 看这些 Pod 所在的节点和当前 Pod 的节点是否处于同一“位置”（即标签值相同），最后 namespace 决定匹配范围是当前命名空间还是跨命名空间。</p>
<p><strong>关键字段</strong></p>
<ul>
<li><strong>labelSelector</strong><ul>
<li>选出一组目标 Pod（通过标签匹配）</li>
</ul>
</li>
<li><strong>namespaces</strong><ul>
<li>目标 Pod 所在的命名空间，不填默认当前命名空间</li>
</ul>
</li>
<li><strong>topologyKey</strong><ul>
<li>表示“同一个位置”的判断依据（例如 <code>kubernetes.io/hostname</code>、<code>rack</code>、<code>zone</code>）</li>
</ul>
</li>
</ul>
<h5 id="required（硬亲和性）-1"><a href="#required（硬亲和性）-1" class="headerlink" title="required（硬亲和性）"></a>required（硬亲和性）</h5><p><strong>必须满足</strong>，否则新 Pod 卡在 <code>Pending</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">yaml</span></span><br><span class="line"><span class="string">CopyEdit</span></span><br><span class="line"><span class="attr">affinity:</span></span><br><span class="line">  <span class="attr">podAffinity:</span></span><br><span class="line">    <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">rack</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h5 id="preferred（软亲和性）-1"><a href="#preferred（软亲和性）-1" class="headerlink" title="preferred（软亲和性）"></a>preferred（软亲和性）</h5><p><strong>满足更优先</strong>，不满足也能调度。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">yaml</span></span><br><span class="line"><span class="string">CopyEdit</span></span><br><span class="line"><span class="attr">affinity:</span></span><br><span class="line">  <span class="attr">podAffinity:</span></span><br><span class="line">    <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">podAffinityTerm:</span></span><br><span class="line">          <span class="attr">labelSelector:</span></span><br><span class="line">            <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">myapp</span></span><br><span class="line">          <span class="attr">topologyKey:</span> <span class="string">rack</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-podAntiAffinity-反亲和性"><a href="#2-podAntiAffinity-反亲和性" class="headerlink" title="2.podAntiAffinity-反亲和性"></a>2.podAntiAffinity-反亲和性</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#强制让相同标签 la=anti 的 Pod 分布到不同的 rack 里，防止它们集中在一起。</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">anti</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">     <span class="attr">la:</span> <span class="string">anti</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">con</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">xianchao/tomcat-8.5-jre8:v1</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">&quot;IfNotPresent&quot;</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAntiAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">topologyKey:</span> <span class="string">rack</span></span><br><span class="line">          <span class="attr">labelSelector:</span></span><br><span class="line">            <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">la</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">&quot;In&quot;</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">anti</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-4-污点与容忍-Taints-Tolerations"><a href="#4-4-污点与容忍-Taints-Tolerations" class="headerlink" title="4.4 污点与容忍 (Taints &amp; Tolerations)"></a>4.4 污点与容忍 (Taints &amp; Tolerations)</h3><ul>
<li><p><strong>概念</strong>：Taint污点是节点的“拒绝声明”，容忍（toleration）是 Pod 的“通行证”。 污点的effect跟 Pod 容忍的effect，必须完全一样才能生效。</p>
<ul>
<li><strong>Taint (污点)</strong>：标记节点不接受没有特定容忍度的 Pod。</li>
<li><strong>Toleration (容忍)</strong>：允许 Pod 调度到带有特定污点的节点上。</li>
</ul>
</li>
<li><p><strong><code>kubectl taint</code> 命令</strong>：<code>kubectl taint nodes &lt;node-name&gt; &lt;key&gt;=&lt;value&gt;:&lt;effect&gt;</code>。</p>
</li>
<li><p><strong>Taint Effects</strong>：<code>NoSchedule</code>, <code>PreferNoSchedule</code>, <code>NoExecute</code>。</p>
</li>
</ul>
<p><strong>taint由三部分组成</strong>：</p>
<ul>
<li><strong>key</strong>：污点的名字，比如 <code>key=dedicated</code></li>
<li><strong>value</strong>：具体的值，比如 <code>value=db</code></li>
<li><strong>effect</strong>：影响方式，常见有<ul>
<li><code>NoSchedule</code>：不调度 Pod 上来（除非 Pod 容忍了这个污点）</li>
<li><code>PreferNoSchedule</code>：最好不，但不是绝对禁止</li>
<li><code>NoExecute</code>：不仅不调度，还会把不容忍的 Pod 赶走</li>
</ul>
</li>
</ul>
<p><strong>toleration写法：</strong></p>
<ul>
<li><strong>key &#x2F; value</strong>：匹配哪个污点</li>
<li><strong>operator</strong>：<strong>Equal 表示“值必须等于 value”；Exists 表示“只要有这个 key 就行”</strong></li>
<li><strong>effect</strong>：</li>
<li><strong>tolerationSeconds</strong>：容忍多久（只对 NoExecute 有用）</li>
</ul>
<h4 id="yaml示例-2"><a href="#yaml示例-2" class="headerlink" title="yaml示例"></a>yaml示例</h4><p><strong>1. 给节点加污点</strong></p>
<p>比如你要让节点只跑数据库相关的 Pod：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes &lt;节点名&gt; dedicated=db:NoSchedule</span><br><span class="line"></span><br><span class="line"><span class="comment">#NoSchedule 是 effect，代表不容忍的 Pod不能调度到这个节点</span></span><br></pre></td></tr></table></figure>

<hr>
<p><strong>2. 在 Pod 里加容忍（Toleration）</strong></p>
<p>如果 Pod 想上这个有污点的节点，就得声明容忍它：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;dedicated&quot;</span>          <span class="comment"># 污点的 key</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span>         <span class="comment"># 匹配方式（Equal 或 Exists）</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;db&quot;</span>       <span class="comment"># 污点的值</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span>       <span class="comment"># 容忍的污点类型</span></span><br><span class="line">  <span class="attr">tolerationSeconds:</span> <span class="number">3600</span>   <span class="comment"># 容忍多久（秒）</span></span><br></pre></td></tr></table></figure>

<p>这样 Pod 就拿到了“通行证”，能调度到有 <code>dedicated=db:NoSchedule</code> 污点的节点上。</p>
<hr>
<h3 id="4-5-资源请求与限制-Resource-Requests-Limits"><a href="#4-5-资源请求与限制-Resource-Requests-Limits" class="headerlink" title="4.5 资源请求与限制 (Resource Requests &amp; Limits)"></a>4.5 资源请求与限制 (Resource Requests &amp; Limits)</h3><ul>
<li><p><strong>概念</strong>：</p>
<ul>
<li><p><strong>Requests (请求)</strong>：Pod 调度时保证的最小资源。</p>
</li>
<li><p><strong>Limits (限制)</strong>：Pod 可使用的最大资源。</p>
</li>
</ul>
</li>
<li><p><strong>资源类型</strong>：<code>cpu</code> (m 或 core), <code>memory</code> (Mi, Gi)。</p>
</li>
<li><p><strong>QoS Class (服务质量)</strong>：Guaranteed, Burstable, BestEffort。</p>
</li>
<li><p><strong>YAML 示例</strong>：</p>
</li>
</ul>
<h2 id="五、网络"><a href="#五、网络" class="headerlink" title="五、网络"></a>五、网络</h2><h3 id="5-1-Service-服务"><a href="#5-1-Service-服务" class="headerlink" title="5.1 Service (服务)"></a>5.1 Service (服务)</h3><ul>
<li><strong>概念</strong>：为一组 Pod 提供稳定的网络访问方式和负载均衡。</li>
<li>在 Kubernetes 集群中，Pod 是可以随时创建、销毁和重新调度的。这意味着它们的 IP 地址是动态变化的。如果一个前端应用需要与后端 Pod 通信，直接使用 Pod 的 IP 地址是不可靠的。</li>
</ul>
<p><strong>Service 解决了这些问题。它充当了 Pod 的一个抽象层和稳定代理。</strong></p>
<aside> 💡

<p>Pod 请求 → Service(ClusterIP) → kube-proxy 查 Endpoints → 挑选 Pod IP:Port → 转发流量</p>
</aside>

<p><em>Service 解决的核心问题：</em></p>
<ol>
<li>Pod IP 动态变化</li>
<li>Pod 数量弹性伸缩</li>
<li>服务发现和负载均衡</li>
</ol>
<ul>
<li><p><strong>Service 类型</strong>：</p>
<ul>
<li><code>ClusterIP</code> (默认)：集群内部访问。</li>
<li><code>NodePort</code>：通过节点 IP 和端口从外部访问。</li>
<li><code>LoadBalancer</code>：云服务商提供外部负载均衡。</li>
<li><code>ExternalName</code>：外部服务别名。</li>
</ul>
</li>
<li><p><strong>Endpoints</strong>：Service 关联的 Pod IP 和端口列表。</p>
</li>
<li><p><strong>Headless Service</strong>：不分配 <code>ClusterIP</code>，用于 StatefulSet。</p>
</li>
</ul>
<h6 id="Service-的-FQDN"><a href="#Service-的-FQDN" class="headerlink" title="Service 的 FQDN"></a>Service 的 <strong>FQDN</strong></h6><p>Kubernetes 集群里，Service 的 <strong>FQDN（完全限定域名-Fully Qualified Domain Name）</strong> 有一个固定规则</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;service-name&gt;.&lt;namespace&gt;.svc.cluster.local</span></span><br><span class="line"></span><br><span class="line"><span class="string">svc</span> <span class="string">表示这是一个</span> <span class="string">Service</span> <span class="string">对象</span></span><br><span class="line"></span><br><span class="line"><span class="string">cluster.local</span> <span class="string">是集群的默认域</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="5-2-Ingress-入口"><a href="#5-2-Ingress-入口" class="headerlink" title="5.2 Ingress (入口)"></a>5.2 Ingress (入口)</h3><ul>
<li><p><strong>概念</strong>：从集群外部访问集群内 Service 的 HTTP&#x2F;HTTPS 路由规则。</p>
</li>
<li><p><strong>组件</strong>：Ingress Resource (定义规则), Ingress Controller (实现规则, 如 Nginx Ingress Controller)。</p>
</li>
<li><p><strong>YAML 示例</strong>：<code>rules</code>, <code>host</code>, <code>paths</code>, <code>backend</code>。</p>
</li>
</ul>
<aside> ♦️

<p>四层代理service</p>
<p>Service 存在的核心问题：仅支持四层代理，基于IP和端口代理，无法直接处理七层协议（如 HTTP&#x2F;HTTPS）的流量。</p>
<p>Service的type类型有很多，如NodePort、clusterIp、loadbalancer、externalname，如果Service想要被k8s集群外部访问，需要用NodePort类型。nodeport会在物理机映射一个端口，绑定到物理机上，这样就导致，每个服务都要映射一个端口，端口过多，维护困难</p>
</aside>

<h4 id="1-1-什么是Ingress"><a href="#1-1-什么是Ingress" class="headerlink" title="1.1 什么是Ingress"></a>1.1 什么是Ingress</h4><p>Ingress是Kubernetes中管理外部访问集群内服务的API对象，通常管理HTTP和HTTPS流量。它提供负载均衡、SSL终止和基于名称的虚拟主机等功能。</p>
<h4 id="1-2-为什么需要Ingress"><a href="#1-2-为什么需要Ingress" class="headerlink" title="1.2 为什么需要Ingress"></a>1.2 为什么需要Ingress</h4><ul>
<li><strong>Service的局限性</strong>：NodePort和LoadBalancer类型的Service在大规模场景下不够灵活</li>
<li><strong>统一入口</strong>：提供集群的统一访问入口点</li>
<li><strong>高级路由</strong>：支持基于域名、路径的路由规则</li>
<li><strong>SSL&#x2F;TLS终止</strong>：集中处理HTTPS证书</li>
<li><strong>成本优化</strong>：避免为每个服务创建LoadBalancer<br>![ingress]((&#x2F;images&#x2F;Untitled diagram _ Mermaid Chart-2025-09-11-012859.png)</li>
</ul>
<h3 id="5-3-CNI-插件-CNI-Plugins"><a href="#5-3-CNI-插件-CNI-Plugins" class="headerlink" title="5.3 CNI 插件 (CNI Plugins)"></a>5.3 CNI 插件 (CNI Plugins)</h3><ul>
<li><p><strong>概念</strong>：Container Network Interface，提供 Pod 网络实现。</p>
</li>
<li><p><strong>常见插件</strong>：Calico, Flannel, Weave Net (了解其作用，无需深入配置)。</p>
</li>
</ul>
<h3 id="5-4-网络策略-Network-Policies"><a href="#5-4-网络策略-Network-Policies" class="headerlink" title="5.4 网络策略 (Network Policies)"></a>5.4 网络策略 (Network Policies)</h3><ul>
<li><p><strong>概念</strong>：基于 Pod 标签、Namespace 等定义 Pod 间的网络访问规则。</p>
</li>
<li><p><strong>作用</strong>：实现微隔离，增强安全性。</p>
</li>
<li><p><strong>YAML 示例</strong>：<code>podSelector</code>, <code>ingress</code>, <code>egress</code>。</p>
</li>
</ul>
<h2 id="六、存储-Storage"><a href="#六、存储-Storage" class="headerlink" title="六、存储 (Storage)"></a>六、存储 (Storage)</h2><h3 id="6-1-Volume"><a href="#6-1-Volume" class="headerlink" title="6.1 Volume"></a><strong>6.1 Volume</strong></h3><ul>
<li><strong>概念</strong>：Pod 中容器间共享数据的存储。</li>
<li><strong>类型</strong>：<code>emptyDir</code>, <code>hostPath</code>, <code>ConfigMap</code>, <code>Secret</code>, <code>PersistentVolumeClaim</code>。</li>
</ul>
<h4 id="emptyDir"><a href="#emptyDir" class="headerlink" title="emptyDir"></a>emptyDir</h4><p><strong><code>emptyDir</code></strong> 是一种临时的、空目录卷，它是在 Pod 被调度到节点上时创建的。</p>
<p>这个卷的生命周期与 Pod 相同，只要 Pod 还在运行，它就存在。一旦 Pod 被删除或终止，<strong><code>emptyDir</code></strong> 中的所有数据都会被永久清除。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod_emptydir</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">contain_1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume_1</span> <span class="comment"># volumeMounts 的 name 应该与 volumes 的 name 对应</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/cache</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">volume_1</span></span><br><span class="line">      <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看所在node和uuid</span></span><br><span class="line">[<span class="string">root@master</span> <span class="string">volume</span>]<span class="comment"># kubectl get pod pod-emptydir -o wide</span></span><br><span class="line"><span class="string">NAME</span>           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>     <span class="string">IP</span>              <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">pod-emptydir</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">9m59s</span>   <span class="number">10.244</span><span class="number">.104</span><span class="number">.28</span>   <span class="string">node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line">[<span class="string">root@master</span> <span class="string">volume</span>]<span class="comment"># kubectl get pods pod-emptydir -o yaml | grep uid</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">d298e2ad-f201-4d5f-a8d4-6cd5b0b440ba</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">#在对应node节点上查看</span></span><br><span class="line">[<span class="string">root@node2</span> <span class="string">~</span>]<span class="comment"># cd /var/lib/kubelet/pods</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="hostPath"><a href="#hostPath" class="headerlink" title="hostPath"></a>hostPath</h4><p>将 Pod 所在节点（Host）上的一个文件或目录，直接挂载到 Pod 内部。</p>
<p><code>hostPath</code> 中的数据<strong>是持久的</strong>，即使 Pod 被删除，数据也会保留在节点上。这种卷主要用于需要访问节点底层文件系统的场景，比如系统监控或日志收集。然而，<code>hostPath</code> 存在安全风险，并且会破坏 Pod 的可移植性，因此在大多数情况下，并不推荐使用。</p>
<ul>
<li><code>hostPath</code> 类型及其含义：<ul>
<li><strong><code>DirectoryOrCreate</code></strong>: 如果指定路径不存在，Kubernetes 会创建一个<strong>空目录</strong>。如果路径已存在，它必须是一个目录。</li>
<li><strong><code>Directory</code></strong>: 挂载前，节点上的指定路径<strong>必须已经存在且是一个目录</strong>。如果不是，Pod 将无法启动。</li>
<li><strong><code>FileOrCreate</code></strong>: 如果指定路径不存在，Kubernetes 会创建一个<strong>空文件</strong>。如果路径已存在，它必须是一个文件。</li>
<li><strong><code>File</code></strong>: 挂载前，节点上的指定路径<strong>必须已经存在且是一个文件</strong>。如果不是，Pod 将无法启动。</li>
</ul>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-hostpath</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node1</span>  <span class="comment"># &lt;-- 指定node</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span>  <span class="comment"># &lt;-- 这里需要指定卷的名称</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/test-nginx</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-tomcat</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat:8.5-jre8-alpine</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span>  <span class="comment"># &lt;-- 这里也需要指定卷的名称</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/test-tomcat</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># volumes 字段应该在这里，与 containers 平级</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span> </span><br><span class="line">     <span class="attr">path:</span> <span class="string">/data1</span></span><br><span class="line">     <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建之后，可以进入pod查看，</span></span><br><span class="line">[<span class="string">root@master</span> <span class="string">volume</span>]<span class="comment"># kubectl exec -it test-hostpath -- /bin/bash</span></span><br><span class="line"><span class="string">Defaulted</span> <span class="string">container</span> <span class="string">&quot;test-nginx&quot;</span> <span class="attr">out of:</span> <span class="string">test-nginx,</span> <span class="string">test-tomcat</span></span><br><span class="line"><span class="comment">#不指定容器，默认nginx</span></span><br><span class="line"></span><br><span class="line"><span class="string">root@test-hostpath:/#</span> <span class="string">kubectl</span> <span class="string">exec</span> <span class="string">-it</span> <span class="string">test-hostpath</span> <span class="string">-c</span> <span class="string">test-tomcat</span> <span class="string">--</span> <span class="string">/bin/bash</span></span><br></pre></td></tr></table></figure>

<h4 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h4><p>允许 Pod 挂载一个来自远程 NFS 服务器的共享目录。</p>
<p>简单来说，它将 NFS 网络共享作为 Kubernetes 的持久化存储来使用，从而解决了 <code>emptyDir</code> 和 <code>hostPath</code> 所不具备的几个关键问题。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-nfs</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:v1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-volumes</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-volumes</span></span><br><span class="line">    <span class="attr">nfs:</span></span><br><span class="line">      <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.180</span>   <span class="comment">#nfs服务端IP</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data/volumes</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-PV与PVC"><a href="#6-2-PV与PVC" class="headerlink" title="6.2 PV与PVC"></a><strong>6.2 PV与PVC</strong></h3><p><strong>PersistentVolume</strong><br><strong>PersistentVolumeClaim</strong></p>
<p>用户通过 <strong>PVC</strong> 来申请 PV，就像“我要一块 10Gi 的盘”。</p>
<p>调度器会把 PVC 和合适的 PV 绑定起来，Pod 再去挂载 PVC，就能拿到这块盘。</p>
<ul>
<li><p><strong>供应方式</strong></p>
<p>  <strong>1. 静态供应（Static Provisioning）</strong></p>
<p>  管理员提前创建好 PV，指定存储类型和大小（比如 NFS 共享目录、云盘、Ceph 卷）。</p>
<p>  用户写 PVC 时，如果大小和访问模式匹配，就能直接绑定。</p>
<p>  缺点是比较死板，用多少准备多少，容易浪费。</p>
<p>  <strong>2. 动态供应（Dynamic Provisioning）</strong></p>
<p>  用户只写 PVC，不用管 PV 存在不存在。</p>
<p>  Kubernetes 会根据 PVC 的需求，调用对应的 <strong>StorageClass</strong>，自动生成一个 PV。</p>
<p>  这样灵活得多，尤其是在云环境下（比如 AWS EBS、GCP Persistent Disk、阿里云盘），想要多大就给你创建多大。</p>
</li>
<li><p><strong>访问模式</strong><br>访问模式（<code>accessModes</code>）同时存在于 PV 和 PVC 中，但它们代表的含义不同：<strong>PV 的 <code>accessModes</code> 声明了存储的“能力”。PVC 的 <code>accessModes</code> 表达了用户的“需求”。</strong></p>
<p>  <strong><code>accessModes</code> <code>&lt;[]string&gt;</code></strong></p>
<ul>
<li><strong>RWO<code>ReadWriteOnce</code></strong> ：只能被<strong>一个节点</strong>以读写方式挂载。</li>
<li><strong>ROX<code>ReadOnlyMany</code></strong>：可以被<strong>多个节点</strong>以只读方式挂载。</li>
<li><strong>RWX<code>ReadWriteMany</code></strong> ：可以被<strong>多个节点</strong>以读写方式挂载。这是 NFS 等共享存储最常使用的模式。</li>
</ul>
</li>
<li><p><strong>回收策略</strong><br>  **reclaimPolicy：**决定了 <strong>PVC 被删除后，PV 怎么处理</strong>：</p>
<ul>
<li><strong>Retain</strong>（默认）：PVC 删除后，PV 状态会变成 <code>Released</code>，但数据还在，需要你手动清理并重新设置才能再用。</li>
<li><strong>Delete</strong>：PVC 删除时，底层存储（比如 AWS EBS、GCE PD、动态 NFS 子目录）也会一起删掉。</li>
</ul>
</li>
<li><p>pv</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volumes/v1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">172.20</span><span class="number">.196</span><span class="number">.17</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>pvc</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">500Ki</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>删除pvc的步骤：需要先删除使用pvc的pod，再删除pvc</p>
<h3 id="6-3-StorageClass"><a href="#6-3-StorageClass" class="headerlink" title="6.3 StorageClass"></a><strong>6.3 StorageClass</strong></h3><ul>
<li><strong>概念</strong>：动态地供应 pv。在没有 StorageClass 之前，管理员需要手动创建每一个 PV，来满足开发者的 PVC 请求。如果集群中有成百上千个存储需求，这会变得非常低效。有了 StorageClass，这个过程就完全自动化了。开发者只需要在 <strong>PVC</strong> 中指定他们想要的 StorageClass 名称，Kubernetes 就会自动调用相应的<strong>供应器（Provisioner）</strong>，为该 PVC 创建一个匹配的 PV。</li>
<li><strong>关键字段</strong><ul>
<li><code>provisioner</code>供应商</li>
<li><code>parameters</code>参数</li>
<li><code>reclaimPolicy</code>回收策略</li>
</ul>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-sc</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">cluster.local/nfs-client-provisioner</span>   <span class="comment"># 和部署的 nfs-provisioner 的 provisioner 字段一致</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Delete</span>        <span class="comment"># 回收策略，默认是 Delete（也可以是 Retain）</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">Immediate</span> <span class="comment"># 立即绑定（另一种是 WaitForFirstConsumer）</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="七、安全-Security"><a href="#七、安全-Security" class="headerlink" title="七、安全 (Security)"></a>七、安全 (Security)</h2><p>🌐 API 请求 → 🔍 认证 → ✅ 授权 → 🛡️ 准入控制 → ⚡ 执行<br>     ↓          ↓          ↓             ↓          ↓<br>   谁在请求    你是谁    你能做什么   做的合规吗     实际执行</p>
<p>Kubernetes 的安全管理通过<strong>认证 → 授权 → 准入控制</strong>三道防线，构建了完整的安全防护体系：</p>
<ol>
<li><strong>认证</strong>确保请求者身份可信</li>
<li><strong>授权</strong>确保请求者有相应权限</li>
<li><strong>准入控制</strong>确保请求内容符合策略</li>
</ol>
<h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><p>kubernetes主要通过<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=API&spm=1001.2101.3001.7020">API</a>server对外提供服务，那么就需要对访问apiserver的用户做认证</p>
<h4 id="1-用户类型"><a href="#1-用户类型" class="headerlink" title="1.用户类型"></a>1.用户类型</h4><ol>
<li><p><strong>User（用户）</strong> - 真实用户账户</p>
 <aside> 💡
 
<p> <em>Kubernetes 没有 User 对象，用户信息来自：</em></p>
<ul>
<li>客户端证书的 Subject</li>
<li>Bearer Token</li>
<li>认证代理的头信息</li>
<li>外部身份提供商</li>
</ul>
 </aside>
 </li>
<li><p><strong>Group（用户组）</strong> - 用户组</p>
</li>
<li><p><strong>ServiceAccount（服务账户）</strong> - Pod 使用的账户</p>
</li>
</ol>
<h4 id="2-k8s客户端访问apiserver的几种认证方式"><a href="#2-k8s客户端访问apiserver的几种认证方式" class="headerlink" title="2.k8s客户端访问apiserver的几种认证方式"></a>2.k8s客户端访问apiserver的几种认证方式</h4><ol>
<li>客户端证书（Client Certificates）</li>
</ol>
<p><strong>原理</strong>：管理员通过集群的 CA (Certificate Authority) 签发一个客户端证书。这个证书包含了用户的身份信息。</p>
<ol start="2">
<li>Service Account</li>
</ol>
<p>这是 Kubernetes <strong>内部 Pods</strong> 认证自己的<strong>唯一方式</strong>。</p>
<p><strong>使用场景</strong>：集群内部的<strong>应用程序</strong>或<strong>控制器</strong>（如你的日志收集器、CI&#x2F;CD 工具）访问 API Server 时使用。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 步骤 1: 定义一个 ServiceAccount</span></span><br><span class="line"><span class="comment"># 这是一个为应用程序提供身份的账户，它没有密码，只依赖于自动生成的令牌。</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-sa</span> <span class="comment"># ServiceAccount 的名称，将在 Pod 中引用</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#将serviceaccount绑定到pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">my-sa</span>   </span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<h3 id="授权Authorization-RBAC"><a href="#授权Authorization-RBAC" class="headerlink" title="授权Authorization-RBAC"></a><strong>授权Authorization-RBAC</strong></h3><p><strong>什么是RBAC（基于角色的授权）？</strong></p>
<p>让一个用户（Users）扮演一个角色（Role），角色拥有权限，从而让用户拥有这样的权限。</p>
<h4 id="RBAC-权限流向"><a href="#RBAC-权限流向" class="headerlink" title="RBAC 权限流向"></a>RBAC 权限流向</h4><p>主体(用户&#x2F;组&#x2F;SA) → 绑定 → 角色 → 资源</p>
<h4 id="角色和绑定关系"><a href="#角色和绑定关系" class="headerlink" title="角色和绑定关系"></a>角色和绑定关系</h4><p>Role + RoleBinding：权限被限制在一个命名空间内。 ClusterRole + RoleBinding：引用全局的 ClusterRole，但权限仍被限制在 RoleBinding 所在的一个命名空间内。 ClusterRole + ClusterRoleBinding：权限在整个集群内有效。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">config:</span><br><span class="line">  theme: redux</span><br><span class="line">  look: classic</span><br><span class="line">---</span><br><span class="line">flowchart TD</span><br><span class="line"> subgraph subjects[&quot;主体（Subjects）&quot;]</span><br><span class="line">        user[&quot;User&lt;br&gt;用户&lt;br&gt;&quot;]</span><br><span class="line">        group[&quot;Group&lt;br&gt;用户组&lt;br&gt;&quot;]</span><br><span class="line">        serviceaccount[&quot;ServiceAccount&lt;br&gt;服务账户&lt;br&gt;&quot;]</span><br><span class="line">  end</span><br><span class="line"> subgraph binding[&quot;绑定（Binding）&quot;]</span><br><span class="line">        rolebinding[&quot;RoleBinding&lt;br&gt;命名空间级别&lt;br&gt;&quot;]</span><br><span class="line">        clusterrolebinding[&quot;ClusterRoleBinding&lt;br&gt;集群级别&lt;br&gt;&quot;]</span><br><span class="line">  end</span><br><span class="line"> subgraph roles[&quot;角色（Roles）&quot;]</span><br><span class="line">        role[&quot;Role&lt;br&gt;命名空间级别&lt;br&gt;&quot;]</span><br><span class="line">        clusterrole[&quot;ClusterRole&lt;br&gt;集群级别&lt;br&gt;&quot;]</span><br><span class="line">  end</span><br><span class="line"> subgraph k8sresources[&quot;Kubernetes 资源&quot;]</span><br><span class="line">        pods[&quot;Pods&quot;]</span><br><span class="line">        services[&quot;Services&quot;]</span><br><span class="line">        configmaps[&quot;ConfigMaps&quot;]</span><br><span class="line">        secrets[&quot;Secrets&quot;]</span><br><span class="line">  end</span><br><span class="line">    subjects --&gt; binding</span><br><span class="line">    binding --&gt; roles</span><br><span class="line">    roles --&gt; k8sresources</span><br><span class="line">     user:::users</span><br><span class="line">     user:::pod</span><br><span class="line">     group:::groups</span><br><span class="line">     group:::pod</span><br><span class="line">     serviceaccount:::cr</span><br><span class="line">     serviceaccount:::pod</span><br><span class="line">     rolebinding:::rb</span><br><span class="line">     rolebinding:::Rose</span><br><span class="line">     clusterrolebinding:::crb</span><br><span class="line">     clusterrolebinding:::Rose</span><br><span class="line">     role:::r</span><br><span class="line">     role:::groups</span><br><span class="line">     clusterrole:::cr</span><br><span class="line">     clusterrole:::roles</span><br><span class="line">     clusterrole:::groups</span><br><span class="line">     pods:::pod</span><br><span class="line">     pods:::resources</span><br><span class="line">     services:::pod</span><br><span class="line">     services:::resources</span><br><span class="line">     configmaps:::pod</span><br><span class="line">     configmaps:::resources</span><br><span class="line">     secrets:::pod</span><br><span class="line">     secrets:::resources</span><br><span class="line">    classDef sa fill:#BA68C8,stroke:#8E24AA,color:#fff</span><br><span class="line">    classDef binding fill:#4DB6AC,stroke:#00796B,color:#fff</span><br><span class="line">    classDef rb fill:#FFD54F,stroke:#FBC02D,color:#fff</span><br><span class="line">    classDef r fill:#4DD0E1,stroke:#0097A7,color:#fff</span><br><span class="line">    classDef text fill:white,color:white</span><br><span class="line">    classDef users fill:#4FC3F7, stroke:#0288D1, color:#fff</span><br><span class="line">    classDef cr fill:#81D4FA, stroke:#0288D1, color:#fff</span><br><span class="line">    classDef Rose stroke-width:1px, stroke-dasharray:none, stroke:#FF5978, fill:#FFDFE5, color:#8E2236</span><br><span class="line">    classDef roles fill:#AED581, stroke:#689F38, color:#fff</span><br><span class="line">    classDef groups fill:#81C784, stroke:#388E3C, color:#fff</span><br><span class="line">    classDef resources fill:#FFB74D, stroke:#F57C00, color:#fff</span><br><span class="line">    classDef crb fill:#64B5F6, stroke:#1976D2, color:#fff</span><br><span class="line">    classDef pod fill:#90CAF9, stroke:#1565C0, color:#fff</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 步骤 1: 创建 Role</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 这个 Role 定义了一组权限，允许对 pods 和 deployments 资源进行 &quot;get&quot;, &quot;watch&quot;, &quot;list&quot; 操作。</span></span><br><span class="line"><span class="comment"># 这个 Role 只在 default 命名空间中生效。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-and-deployment-reader</span></span><br><span class="line"><span class="attr">rules:</span>    </span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]        <span class="comment"># &quot;&quot; 表示核心 API 组</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]    </span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"> <span class="comment">#角色可以读取核心 API 组中的所有 Pod 资源。</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;deployments&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"> <span class="comment">#角色可以读取 apps API 组中的所有 Deployment 资源。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 步骤 2: 创建 RoleBinding</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 这个 RoleBinding 将上面创建的 &quot;pod-and-deployment-reader&quot; 角色，</span></span><br><span class="line"><span class="comment"># 授予给 &quot;dev-sa&quot; 服务账户。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-pods-deployments-in-default</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span> <span class="comment">#和什么主体绑定</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-sa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span>  <span class="comment">#绑定哪个role</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-and-deployment-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#以alice获取pod信息，被禁止</span></span><br><span class="line">[<span class="string">root@master</span> <span class="string">sa</span>]<span class="comment"># kubectl get pod --as=alice</span></span><br><span class="line"><span class="attr">Error from server (Forbidden): pods is forbidden:</span> <span class="string">User</span> <span class="string">&quot;alice&quot;</span> <span class="string">cannot</span> <span class="string">list</span> <span class="string">resource</span> <span class="string">&quot;pods&quot;</span> <span class="string">in</span> <span class="string">API</span> <span class="string">group</span> <span class="string">&quot;&quot;</span> <span class="string">in</span> <span class="string">the</span> <span class="string">namespace</span> <span class="string">&quot;default&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#步骤 1: 创建 Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">role1</span>   <span class="comment">#命名role</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>]</span><br><span class="line"><span class="comment">#角色可以获取和列出核心 API 组中的所有 Pod 资源。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#步骤 2：创建rolebinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rolebind1</span>  <span class="comment">#命名rolebindinf</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span>   <span class="comment">#绑定哪个role</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span>   </span><br><span class="line">  <span class="comment">#定义了角色所属的 API 组。对于 RBAC 资源，这个值是固定的</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">role1</span></span><br><span class="line"><span class="attr">subjects:</span>  <span class="comment">##和什么主体绑定</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alice</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#此时再次尝试，成功get到pod信息</span></span><br><span class="line">[<span class="string">root@master</span> <span class="string">sa</span>]<span class="comment"># kubectl get pod --as=alice</span></span><br><span class="line"><span class="string">NAME</span>                               <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>        <span class="string">AGE</span></span><br><span class="line"><span class="string">nfs-provisioner-7dbd9f7b8b-gmnzt</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">14</span> <span class="string">(139m</span> <span class="string">ago)</span>   <span class="string">5d1h</span></span><br><span class="line"><span class="string">web-0</span>                              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>               <span class="string">4d22h</span></span><br><span class="line"><span class="string">web-1</span>                              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>               <span class="string">4d22h</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#列出集群中所有资源类型</span></span><br><span class="line">kubectl api-resources</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证权限</span></span><br><span class="line">kubectl auth can-i </span><br><span class="line">kubectl auth can-i --list</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="准入控制-Admission-Control"><a href="#准入控制-Admission-Control" class="headerlink" title="准入控制-Admission Control"></a>准入控制-Admission Control</h3><p>在API请求到达etcd存储之前的<strong>最后一道关卡</strong>，可以修改或拒绝请求。常见的有：</p>
<h4 id="ResourceQuota"><a href="#ResourceQuota" class="headerlink" title="ResourceQuota"></a>ResourceQuota</h4><p>在<strong>命名空间级别</strong>限制资源总量使用：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">compute-quota</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">myteam</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">requests.cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">requests.memory:</span> <span class="string">8Gi</span></span><br><span class="line">    <span class="attr">limits.cpu:</span> <span class="string">&quot;8&quot;</span></span><br><span class="line">    <span class="attr">limits.memory:</span> <span class="string">16Gi</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;10&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="LimitRanger"><a href="#LimitRanger" class="headerlink" title="LimitRanger"></a>LimitRanger</h4><p>在<strong>单个对象级别</strong>设置资源使用的范围限制：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-memory-limit-range</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">default:</span>          <span class="string">*#</span> <span class="string">默认limit*</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">256Mi</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">defaultRequest:</span>    <span class="string">*#</span> <span class="string">默认request*</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">max:</span>              <span class="string">*#</span> <span class="string">最大值*</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">min:</span>              <span class="string">*#</span> <span class="string">最小值*</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">50m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">64Mi</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Container</span></span><br></pre></td></tr></table></figure>
<h2 id="八、集群维护-Cluster-Maintenance"><a href="#八、集群维护-Cluster-Maintenance" class="headerlink" title="八、集群维护 (Cluster Maintenance)"></a>八、集群维护 (Cluster Maintenance)</h2><h3 id="8-1-集群升级-Cluster-Upgrades"><a href="#8-1-集群升级-Cluster-Upgrades" class="headerlink" title="8.1 集群升级 (Cluster Upgrades)"></a>8.1 集群升级 (Cluster Upgrades)</h3><ul>
<li><p><strong><code>kubeadm</code> 升级</strong>：</p>
<ul>
<li><p>Master 节点升级 (<code>kubeadm upgrade apply</code>)。</p>
</li>
<li><p>Worker 节点升级 (<code>kubeadm upgrade node</code>)。</p>
</li>
<li><p><code>kubectl drain</code>, <code>kubectl uncordon</code>。</p>
</li>
</ul>
</li>
</ul>
<h3 id="8-2-节点维护-Node-Maintenance"><a href="#8-2-节点维护-Node-Maintenance" class="headerlink" title="8.2 节点维护 (Node Maintenance)"></a>8.2 节点维护 (Node Maintenance)</h3><ul>
<li><p><strong>排空节点</strong>：<code>kubectl drain &lt;node-name&gt;</code> (将 Pod 驱逐出节点)。</p>
</li>
<li><p><strong>解除排空</strong>：<code>kubectl uncordon &lt;node-name&gt;</code> (允许 Pod 重新调度到节点)。</p>
</li>
<li><p><strong>移除节点</strong>：<code>kubeadm reset</code> (在节点上执行), <code>kubectl delete node &lt;node-name&gt;</code>。</p>
</li>
</ul>
<h3 id="8-3-ETCD-操作-ETCD-Operations"><a href="#8-3-ETCD-操作-ETCD-Operations" class="headerlink" title="8.3 ETCD 操作 (ETCD Operations)"></a>8.3 ETCD 操作 (ETCD Operations)</h3><ul>
<li><p><strong>集群健康检查</strong>：<code>etcdctl endpoint health</code>。</p>
</li>
<li><p><strong>成员管理</strong>：<code>etcdctl member list</code>, <code>etcdctl member add/remove</code>。</p>
</li>
</ul>
<h2 id="九、日志与监控-Logging-Monitoring"><a href="#九、日志与监控-Logging-Monitoring" class="headerlink" title="九、日志与监控 (Logging &#x2F; Monitoring)"></a>九、日志与监控 (Logging &#x2F; Monitoring)</h2><h3 id="9-1-日志收集-Log-Collection"><a href="#9-1-日志收集-Log-Collection" class="headerlink" title="9.1 日志收集 (Log Collection)"></a>9.1 日志收集 (Log Collection)</h3><ul>
<li><p><strong>Pod 日志</strong>：<code>kubectl logs</code>, <code>kubectl logs -f</code>。</p>
</li>
<li><p><strong>节点日志</strong>：<code>journalctl -u kubelet</code>, <code>journalctl -u docker</code> 或 <code>containerd</code>。</p>
</li>
<li><p><strong>日志收集方案</strong>：Fluentd, Loki (概念性了解)。</p>
</li>
</ul>
<h3 id="9-2-监控工具-Monitoring-Tools-Concepts"><a href="#9-2-监控工具-Monitoring-Tools-Concepts" class="headerlink" title="9.2 监控工具 (Monitoring Tools - Concepts)"></a>9.2 监控工具 (Monitoring Tools - Concepts)</h3><ul>
<li><p><strong>Prometheus &#x2F; Grafana</strong>：K8s 监控的事实标准 (了解架构和作用)。</p>
</li>
<li><p><strong>Metrics Server</strong>：提供基本的 CPU&#x2F;内存指标 (<code>kubectl top</code>)。</p>
</li>
</ul>
<h3 id="9-3-健康检查-Probes"><a href="#9-3-健康检查-Probes" class="headerlink" title="9.3 健康检查 (Probes)"></a>9.3 健康检查 (Probes)</h3><ul>
<li><p><strong>概念</strong>：检查容器是否健康、是否准备好接收流量。</p>
</li>
<li><p><strong><code>livenessProbe</code> (存活探针)</strong>：判断容器是否存活，失败则重启容器。</p>
</li>
<li><p><strong><code>readinessProbe</code> (就绪探针)</strong>：判断容器是否准备好接收流量，失败则从 Service 终点中移除。</p>
</li>
<li><p><strong><code>startupProbe</code> (启动探针)</strong>：判断容器是否启动成功，避免 <code>livenessProbe</code> 过早失败。</p>
</li>
<li><p><strong>探针类型</strong>：<code>exec</code>, <code>httpGet</code>, <code>tcpSocket</code>。</p>
</li>
<li><p><strong>YAML 示例</strong>：</p>
</li>
</ul>
<h2 id="十、故障排除-Troubleshooting"><a href="#十、故障排除-Troubleshooting" class="headerlink" title="十、故障排除 (Troubleshooting)"></a>十、故障排除 (Troubleshooting)</h2><h3 id="10-1-Pod-故障-Pod-Failures"><a href="#10-1-Pod-故障-Pod-Failures" class="headerlink" title="10.1 Pod 故障 (Pod Failures)"></a>10.1 Pod 故障 (Pod Failures)</h3><ul>
<li><p><strong>常见状态</strong>：Pending, CrashLoopBackOff, Error, OOMKilled。</p>
</li>
<li><p><strong>调试命令</strong>：</p>
<ul>
<li><p><code>kubectl describe pod &lt;name&gt;</code> (查看事件、状态、挂载、容器信息)</p>
</li>
<li><p><code>kubectl logs &lt;name&gt; [-c &lt;container&gt;]</code> (查看应用日志)</p>
</li>
<li><p><code>kubectl exec -it &lt;name&gt; -- bash</code> (进入容器调试)</p>
</li>
</ul>
</li>
<li><p><strong>可能原因</strong>：镜像拉取失败、端口冲突、资源不足、配置错误、健康检查失败。</p>
</li>
</ul>
<h3 id="10-2-节点故障-Node-Failures"><a href="#10-2-节点故障-Node-Failures" class="headerlink" title="10.2 节点故障 (Node Failures)"></a>10.2 节点故障 (Node Failures)</h3><ul>
<li><p><strong>常见状态</strong>：NotReady, SchedulingDisabled。</p>
</li>
<li><p><strong>调试命令</strong>：</p>
<ul>
<li><p><code>kubectl get nodes</code></p>
</li>
<li><p><code>kubectl describe node &lt;name&gt;</code> (查看节点事件、资源使用、污点)</p>
</li>
<li><p>SSH 到节点检查 <code>kubelet</code>, <code>containerd/docker</code> 服务状态 (<code>systemctl status kubelet</code>)。</p>
</li>
<li><p>检查节点资源使用。</p>
</li>
</ul>
</li>
<li><p><strong>可能原因</strong>：<code>kubelet</code> 停止、网络问题、磁盘空间不足、内存耗尽。</p>
</li>
</ul>
<h3 id="10-3-网络故障-Networking-Issues"><a href="#10-3-网络故障-Networking-Issues" class="headerlink" title="10.3 网络故障 (Networking Issues)"></a>10.3 网络故障 (Networking Issues)</h3><ul>
<li><p><strong>Pod 间通信</strong>：检查 CNI 插件状态、<code>kube-proxy</code> 日志。</p>
</li>
<li><p><strong>Service 访问</strong>：检查 <code>Service Selector</code> 是否匹配 Pod 标签，<code>Endpoints</code> 是否正确。</p>
</li>
<li><p><strong>外部访问</strong>：检查 <code>NodePort</code>, <code>LoadBalancer</code>, <code>Ingress</code> 配置。</p>
</li>
<li><p><strong>DNS 解析</strong>：检查 <code>coredns</code> Pod 状态、容器内 <code>nslookup</code>。</p>
</li>
</ul>
<h3 id="10-4-存储故障-Storage-Issues"><a href="#10-4-存储故障-Storage-Issues" class="headerlink" title="10.4 存储故障 (Storage Issues)"></a>10.4 存储故障 (Storage Issues)</h3><ul>
<li><p><strong>PVC 状态</strong>：Pending, Bound。</p>
</li>
<li><p><strong>PV 状态</strong>：Available, Bound, Released, Failed。</p>
</li>
<li><p><strong>调试命令</strong>：<code>kubectl describe pvc/pv</code>。</p>
</li>
<li><p><strong>可能原因</strong>：<code>StorageClass</code> 配置错误、存储后端问题、<code>accessModes</code> 不匹配。</p>
</li>
</ul>
<h3 id="10-5-控制平面故障-Control-Plane-Failures"><a href="#10-5-控制平面故障-Control-Plane-Failures" class="headerlink" title="10.5 控制平面故障 (Control Plane Failures)"></a>10.5 控制平面故障 (Control Plane Failures)</h3><ul>
<li><p><strong>API Server 不可用</strong>：<code>etcd</code> 问题、证书过期、端口冲突。</p>
</li>
<li><p><strong>Scheduler 不调度</strong>：<code>kube-scheduler</code> 进程问题、资源不足。</p>
</li>
<li><p><strong>Controller Manager 不工作</strong>：相关控制器错误。</p>
</li>
<li><p><strong>调试</strong>：查看 Master 节点上各组件的静态 Pod 日志 (<code>/etc/kubernetes/manifests/</code>)。</p>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://nikieuphoria.github.io">niki</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://nikieuphoria.github.io/2025/09/30/kubenetes/">https://nikieuphoria.github.io/2025/09/30/kubenetes/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://nikieuphoria.github.io" target="_blank">The Fountainhead</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%BF%90%E7%BB%B4/">运维</a><a class="post-meta__tags" href="/tags/kubenates/">kubenates</a></div><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>buy me a coffee</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/07/15/K8S-day1-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%89%E8%A3%85k8s%E9%9B%86%E7%BE%A4%E7%9A%84%E7%8E%AF%E5%A2%83/" title="K8S-day1-初始化安装k8s集群的环境"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-15</div><div class="info-item-2">K8S-day1-初始化安装k8s集群的环境</div></div><div class="info-2"><div class="info-item-1">初始化安装k8s集群的环境环境与注意事项   主机名 ip地址    master 172.20.196.17   node1 172.20.196.18   node2 172.20.196.19    我用的是云服务器，故一部分操作不需要做。 操作过程可以通过ansible减少重复操作。 在每台机器安装基础软件包  1yum install -y device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack telnet ipvsadm  1.  配置静态ip地址 ...</div></div></div></a><a class="pagination-related" href="/2025/01/21/SElinux-%E5%AE%89%E5%85%A8%E4%B8%8A%E4%B8%8B%E6%96%87/" title="SElinux-安全上下文"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-21</div><div class="info-item-2">SElinux-安全上下文</div></div><div class="info-2"><div class="info-item-1">SElinux-Security-Enhanced Linux 安全增强型 linuxLinux系统安全的强制访问控制体系 三种配置模式 selinux的配置文件：&#x2F;etc&#x2F;sysconfig&#x2F;selinux     状态 含义    enforcing 级别为强制   permissive 级别为警告   disable 关闭    模式管理  1234567891011121314151617#查看当前工作模式[root@server ~]# getenforce[root@server ~]# getenforceEnforcing# 临时关闭进入宽容模式[root@server ~]# setenforce  0  [root@server ~]# getenforcePermissive # 临时开启[root@server ~]# setenforce  1 [root@server ~]# getenforceEnforcing#永久性关闭[root@server ~]# vim  /etc/selinux/config...</div></div></div></a><a class="pagination-related" href="/2023/10/20/docker/" title="docker"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-20</div><div class="info-item-2">docker</div></div><div class="info-2"><div class="info-item-1">docker 一：Docker基础、什么是Docker？Docker是什么？开源的容器化平台，用于构建、打包和运行应用程序和服务 架构：client-server Docker的优势和用途 轻量级容器： Docker容器相对于传统虚拟机更轻量，因为它们共享操作系统内核，而不是运行完整的操作系统。这使得容器更快速启动、更节省资源，并提高了可扩展性。  一致性和可移植性： Docker容器封装了应用程序及其依赖，确保在不同环境中运行一致。这意味着你可以在开发、测试和生产环境之间轻松迁移应用程序。  快速部署： Docker容器可以迅速启动和停止，因此可以更快速地部署和更新应用程序，有助于实现持续集成和持续交付（CI&#x2F;CD）。  隔离性： Docker提供了强大的容器隔离，确保容器内的应用程序不会相互干扰，并提供了一定程度的安全性。  生态系统和社区支持： Docker拥有广泛的生态系统和强大的社区支持，有大量的官方和第三方容器镜像，以及丰富的工具和插件，使得它更容易集成到不同的应用和基础架构中。   📌 用途    微服务架构：...</div></div></div></a><a class="pagination-related" href="/2024/10/30/ansible/" title="ansible"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-30</div><div class="info-item-2">ansible</div></div><div class="info-2"><div class="info-item-1">一、安装与配置1.安装1234567#yum安装yum install epel-release -yyum install ansible –y#查看ansible版本ansible --version  2.管理节点与被管理节点建⽴SSH信任关系2.1.生成私钥 	[root@server ~]# ssh-keygen    2.2.向主机分发私钥 	[root@server ~]# ssh-copy-id root@192.168.37.122 	[root@server ~]# ssh-copy-id root@192.168.37.133  3. ansible配置文件修改配置文件，创建主机清单文件 ：写在[]里的是组名，[ ]下面的是组内的主机名	[root@server ~]# vim &#x2F;etc&#x2F;ansible&#x2F;hosts		[web]		192.168.37.122		192.168.37.133 二、核心组件主机清单（Inventory）模块（Modules）任务（Tasks）和剧本（Playbooks）角色（Roles） ...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">niki</div><div class="author-info-description">You must learn not to be afraid of the world. Never to be hurt by it as you were in that courtroom.You'll win, because you've chosen the hardest way of fighting for your freedom from the world.</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/sosocrown"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/nikieuphoria" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="/zn40489@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://www.douban.com/" target="_blank" title="Douban"><i class="fab fa-douban" style="color: #007722;"></i></a><a class="social-icon" href="/your_wechat_id" target="_blank" title="WeChat"><i class="fas fa-weixin" style="color: #07c160;"></i></a><a class="social-icon" href="https://www.linkedin.com/in/%E6%80%9D%E8%8B%91-%E5%BC%A0-169101283/" target="_blank" title="LinkedIn"><i class="fab fa-linkedin" style="color: #0077b5;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">恭喜，进入了一个空虚的数字世界。如果你遇到技术问题，你可能会在这儿找到一些答案，或者完全没有。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81-%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">一、 集群架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 集群架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-API-%E5%AF%B9%E8%B1%A1-API-Objects"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 API 对象 (API Objects)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-YAML-%E6%96%87%E4%BB%B6-YAML-Files"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 YAML 文件 (YAML Files)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-kubectl-%E5%9F%BA%E7%A1%80-kubectl-Basics"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 kubectl 基础 (kubectl Basics)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">二、集群安装与配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-kubeadm-%E5%B7%A5%E5%85%B7-kubeadm-Tool"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 kubeadm 工具 (kubeadm Tool)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E7%BB%84%E4%BB%B6%E9%85%8D%E7%BD%AE-Component-Configuration"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 组件配置 (Component Configuration)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E8%AF%81%E4%B9%A6%E7%AE%A1%E7%90%86-Certificate-Management"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 证书管理 (Certificate Management)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D-Backup-Restore"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 备份与恢复 (Backup &amp; Restore)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%BA%94%E7%94%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">三、应用生命周期管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Pod-%E7%AE%A1%E7%90%86-Pod-Management"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 Pod 管理 (Pod Management)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1%E5%88%9B%E5%BB%BApod%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">3.1.1.</span> <span class="toc-text">3.1.1创建pod的方式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#kubectl-run%E4%B8%B4%E6%97%B6%E5%88%9B%E5%BB%BA"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">kubectl run临时创建</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%A8-YAML-%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA-Pod"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">用 YAML 文件创建 Pod</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8%E5%88%9B%E5%BB%BA"><span class="toc-number">3.1.1.3.</span> <span class="toc-text">控制器创建</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D"><span class="toc-number">3.1.2.</span> <span class="toc-text">3.1.2 资源配额</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">3.2.</span> <span class="toc-text">3.2pod生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1Pod%E7%9A%84%E4%BA%94%E4%B8%AA%E9%98%B6%E6%AE%B5%EF%BC%88Phase%EF%BC%89"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.2.1Pod的五个阶段（Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2pod%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2.2pod重启策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-3Init-%E5%AE%B9%E5%99%A8%EF%BC%9A%E4%B8%BB%E5%AE%B9%E5%99%A8%E5%89%8D%E7%9A%84%E5%87%86%E5%A4%87%E5%B7%A5%E5%BA%8F"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.2.3Init 容器：主容器前的准备工序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-4hooks%E9%92%A9%E5%AD%90"><span class="toc-number">3.2.4.</span> <span class="toc-text">3.2.4hooks钩子</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-5probe%E6%8E%A2%E9%92%88"><span class="toc-number">3.2.5.</span> <span class="toc-text">3.2.5probe探针</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Liveness-Probe%EF%BC%88%E5%AD%98%E6%B4%BB%E6%8E%A2%E9%92%88%EF%BC%89"><span class="toc-number">3.2.5.1.</span> <span class="toc-text">1. Liveness Probe（存活探针）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-Readiness-Probe%EF%BC%88%E5%B0%B1%E7%BB%AA%E6%8E%A2%E9%92%88%EF%BC%89"><span class="toc-number">3.2.5.2.</span> <span class="toc-text">2. Readiness Probe（就绪探针）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-Startup-Probe%EF%BC%88%E5%90%AF%E5%8A%A8%E6%8E%A2%E9%92%88%EF%BC%89"><span class="toc-number">3.2.5.3.</span> <span class="toc-text">3. Startup Probe（启动探针）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A2%E9%92%88%E6%A3%80%E6%B5%8B%E6%96%B9%E5%BC%8F"><span class="toc-number">3.2.5.4.</span> <span class="toc-text">探针检测方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-DaemonSet-%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E9%9B%86"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 DaemonSet (守护进程集)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-number">3.3.1.</span> <span class="toc-text">定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E7%89%B9%E6%80%A7"><span class="toc-number">3.3.2.</span> <span class="toc-text">主要特性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B8%E5%9E%8B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">3.3.3.</span> <span class="toc-text">典型应用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yaml%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.4.</span> <span class="toc-text">yaml示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-StatefulSet-%E6%9C%89%E7%8A%B6%E6%80%81%E9%9B%86"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 StatefulSet (有状态集)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#StatefulSet-%E7%89%B9%E6%80%A7"><span class="toc-number">3.4.1.</span> <span class="toc-text">StatefulSet 特性</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#yaml%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">3.4.1.0.1.</span> <span class="toc-text">yaml示例</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-configmap%E4%B8%8Esecret"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 configmap与secret</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#configmap"><span class="toc-number">3.5.1.</span> <span class="toc-text">configmap</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BAConfigMap%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">3.5.1.1.</span> <span class="toc-text">1. 创建ConfigMap的方式</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E7%94%A8kubectl%E5%91%BD%E4%BB%A4"><span class="toc-number">3.5.1.1.1.</span> <span class="toc-text">直接用kubectl命令</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%A8YAML%E6%96%87%E4%BB%B6"><span class="toc-number">3.5.1.1.2.</span> <span class="toc-text">用YAML文件</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%9C%A8Pod%E4%B8%AD%E4%BD%BF%E7%94%A8ConfigMap"><span class="toc-number">3.5.1.2.</span> <span class="toc-text">2. 在Pod中使用ConfigMap</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#envfrom"><span class="toc-number">3.5.1.2.1.</span> <span class="toc-text">envfrom</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#configMapKeyRef"><span class="toc-number">3.5.1.2.2.</span> <span class="toc-text">configMapKeyRef</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%81%9A%E6%88%90volume%E6%8C%82%E8%BD%BD"><span class="toc-number">3.5.1.2.3.</span> <span class="toc-text">做成volume挂载</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E8%B0%83%E5%BA%A6"><span class="toc-number">4.</span> <span class="toc-text">四、调度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nodeName"><span class="toc-number">4.1.</span> <span class="toc-text">nodeName</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E8%8A%82%E7%82%B9%E9%80%89%E6%8B%A9%E5%99%A8-Node-Selector"><span class="toc-number">4.2.</span> <span class="toc-text">4.1 节点选择器 (Node Selector)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E8%8A%82%E7%82%B9%E4%BA%B2%E5%92%8C%E6%80%A7-Node-Affinity"><span class="toc-number">4.3.</span> <span class="toc-text">4.2 节点亲和性 (Node Affinity)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#required%EF%BC%88%E7%A1%AC%E4%BA%B2%E5%92%8C%E6%80%A7%EF%BC%89"><span class="toc-number">4.3.1.</span> <span class="toc-text">required（硬亲和性）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#preferred%EF%BC%88%E8%BD%AF%E4%BA%B2%E5%92%8C%E6%80%A7%EF%BC%89"><span class="toc-number">4.3.2.</span> <span class="toc-text">preferred（软亲和性）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-Pod-Affinity-Anti-Affinity"><span class="toc-number">4.4.</span> <span class="toc-text">4.3 Pod Affinity&#x2F;Anti-Affinity</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-podAffinity-%E8%B7%9F%E5%93%AA%E4%BA%9Bpod%E4%B8%80%E8%B5%B7"><span class="toc-number">4.4.1.</span> <span class="toc-text">1.podAffinity -跟哪些pod一起</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#required%EF%BC%88%E7%A1%AC%E4%BA%B2%E5%92%8C%E6%80%A7%EF%BC%89-1"><span class="toc-number">4.4.1.1.</span> <span class="toc-text">required（硬亲和性）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#preferred%EF%BC%88%E8%BD%AF%E4%BA%B2%E5%92%8C%E6%80%A7%EF%BC%89-1"><span class="toc-number">4.4.1.2.</span> <span class="toc-text">preferred（软亲和性）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-podAntiAffinity-%E5%8F%8D%E4%BA%B2%E5%92%8C%E6%80%A7"><span class="toc-number">4.4.2.</span> <span class="toc-text">2.podAntiAffinity-反亲和性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E6%B1%A1%E7%82%B9%E4%B8%8E%E5%AE%B9%E5%BF%8D-Taints-Tolerations"><span class="toc-number">4.5.</span> <span class="toc-text">4.4 污点与容忍 (Taints &amp; Tolerations)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#yaml%E7%A4%BA%E4%BE%8B-2"><span class="toc-number">4.5.1.</span> <span class="toc-text">yaml示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E8%B5%84%E6%BA%90%E8%AF%B7%E6%B1%82%E4%B8%8E%E9%99%90%E5%88%B6-Resource-Requests-Limits"><span class="toc-number">4.6.</span> <span class="toc-text">4.5 资源请求与限制 (Resource Requests &amp; Limits)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E7%BD%91%E7%BB%9C"><span class="toc-number">5.</span> <span class="toc-text">五、网络</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-Service-%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 Service (服务)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Service-%E7%9A%84-FQDN"><span class="toc-number">5.1.0.0.1.</span> <span class="toc-text">Service 的 FQDN</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-Ingress-%E5%85%A5%E5%8F%A3"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 Ingress (入口)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AFIngress"><span class="toc-number">5.2.1.</span> <span class="toc-text">1.1 什么是Ingress</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81Ingress"><span class="toc-number">5.2.2.</span> <span class="toc-text">1.2 为什么需要Ingress</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-CNI-%E6%8F%92%E4%BB%B6-CNI-Plugins"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 CNI 插件 (CNI Plugins)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5-Network-Policies"><span class="toc-number">5.4.</span> <span class="toc-text">5.4 网络策略 (Network Policies)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%AD%98%E5%82%A8-Storage"><span class="toc-number">6.</span> <span class="toc-text">六、存储 (Storage)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-Volume"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 Volume</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#emptyDir"><span class="toc-number">6.1.1.</span> <span class="toc-text">emptyDir</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hostPath"><span class="toc-number">6.1.2.</span> <span class="toc-text">hostPath</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NFS"><span class="toc-number">6.1.3.</span> <span class="toc-text">NFS</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-PV%E4%B8%8EPVC"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 PV与PVC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-StorageClass"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 StorageClass</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%AE%89%E5%85%A8-Security"><span class="toc-number">7.</span> <span class="toc-text">七、安全 (Security)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81"><span class="toc-number">7.1.</span> <span class="toc-text">认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%94%A8%E6%88%B7%E7%B1%BB%E5%9E%8B"><span class="toc-number">7.1.1.</span> <span class="toc-text">1.用户类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-k8s%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AE%BF%E9%97%AEapiserver%E7%9A%84%E5%87%A0%E7%A7%8D%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F"><span class="toc-number">7.1.2.</span> <span class="toc-text">2.k8s客户端访问apiserver的几种认证方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%88%E6%9D%83Authorization-RBAC"><span class="toc-number">7.2.</span> <span class="toc-text">授权Authorization-RBAC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RBAC-%E6%9D%83%E9%99%90%E6%B5%81%E5%90%91"><span class="toc-number">7.2.1.</span> <span class="toc-text">RBAC 权限流向</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%92%E8%89%B2%E5%92%8C%E7%BB%91%E5%AE%9A%E5%85%B3%E7%B3%BB"><span class="toc-number">7.2.2.</span> <span class="toc-text">角色和绑定关系</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6-Admission-Control"><span class="toc-number">7.3.</span> <span class="toc-text">准入控制-Admission Control</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ResourceQuota"><span class="toc-number">7.3.1.</span> <span class="toc-text">ResourceQuota</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LimitRanger"><span class="toc-number">7.3.2.</span> <span class="toc-text">LimitRanger</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E9%9B%86%E7%BE%A4%E7%BB%B4%E6%8A%A4-Cluster-Maintenance"><span class="toc-number">8.</span> <span class="toc-text">八、集群维护 (Cluster Maintenance)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E9%9B%86%E7%BE%A4%E5%8D%87%E7%BA%A7-Cluster-Upgrades"><span class="toc-number">8.1.</span> <span class="toc-text">8.1 集群升级 (Cluster Upgrades)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E8%8A%82%E7%82%B9%E7%BB%B4%E6%8A%A4-Node-Maintenance"><span class="toc-number">8.2.</span> <span class="toc-text">8.2 节点维护 (Node Maintenance)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-ETCD-%E6%93%8D%E4%BD%9C-ETCD-Operations"><span class="toc-number">8.3.</span> <span class="toc-text">8.3 ETCD 操作 (ETCD Operations)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E6%97%A5%E5%BF%97%E4%B8%8E%E7%9B%91%E6%8E%A7-Logging-Monitoring"><span class="toc-number">9.</span> <span class="toc-text">九、日志与监控 (Logging &#x2F; Monitoring)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86-Log-Collection"><span class="toc-number">9.1.</span> <span class="toc-text">9.1 日志收集 (Log Collection)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7-Monitoring-Tools-Concepts"><span class="toc-number">9.2.</span> <span class="toc-text">9.2 监控工具 (Monitoring Tools - Concepts)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5-Probes"><span class="toc-number">9.3.</span> <span class="toc-text">9.3 健康检查 (Probes)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4-Troubleshooting"><span class="toc-number">10.</span> <span class="toc-text">十、故障排除 (Troubleshooting)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-Pod-%E6%95%85%E9%9A%9C-Pod-Failures"><span class="toc-number">10.1.</span> <span class="toc-text">10.1 Pod 故障 (Pod Failures)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-%E8%8A%82%E7%82%B9%E6%95%85%E9%9A%9C-Node-Failures"><span class="toc-number">10.2.</span> <span class="toc-text">10.2 节点故障 (Node Failures)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-%E7%BD%91%E7%BB%9C%E6%95%85%E9%9A%9C-Networking-Issues"><span class="toc-number">10.3.</span> <span class="toc-text">10.3 网络故障 (Networking Issues)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-%E5%AD%98%E5%82%A8%E6%95%85%E9%9A%9C-Storage-Issues"><span class="toc-number">10.4.</span> <span class="toc-text">10.4 存储故障 (Storage Issues)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-5-%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2%E6%95%85%E9%9A%9C-Control-Plane-Failures"><span class="toc-number">10.5.</span> <span class="toc-text">10.5 控制平面故障 (Control Plane Failures)</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/14/%E9%A6%99%E8%8A%8B%E9%A6%99%E7%83%9F/" title="鹈鹕镇">鹈鹕镇</a><time datetime="2025-10-13T16:00:00.000Z" title="发表于 2025-10-14 00:00:00">2025-10-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/30/kubenetes/" title="kubenetes">kubenetes</a><time datetime="2025-09-29T16:00:00.000Z" title="发表于 2025-09-30 00:00:00">2025-09-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/17/%E8%87%AA%E7%94%B1%EF%BC%8C%E5%BE%88%E8%AF%B1%E4%BA%BA%E5%95%8A/" title="自由，很诱人啊">自由，很诱人啊</a><time datetime="2025-09-16T16:00:00.000Z" title="发表于 2025-09-17 00:00:00">2025-09-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/03/%E8%B4%AA%E5%97%94%E7%97%B4%E6%81%A8%E7%88%B1%E6%81%B6%E6%AC%B2/" title="贪嗔痴恨爱恶欲">贪嗔痴恨爱恶欲</a><time datetime="2025-09-02T16:00:00.000Z" title="发表于 2025-09-03 00:00:00">2025-09-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/05/%E8%96%9B%E5%AE%9A%E8%B0%94%EF%BC%8C%E4%BD%A0%E5%9C%A8%E5%90%97%EF%BC%9F/" title="薛定谔，你在吗？">薛定谔，你在吗？</a><time datetime="2025-08-04T16:00:00.000Z" title="发表于 2025-08-05 00:00:00">2025-08-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2025 By niki</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to the <a target="_blank" rel="noopener" href="https://sosocrown.github.io//">fountainhead</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索内容..." type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>